# Диалоговые флоу — @DealDeskBot (v2)

## 0) Контекст
Бот для ленты офферов и сделок. Работает в паре со шлюзом @ClubGateBot. Поддерживает обычные сделки (pass‑through / deposit‑mode) и **EOD‑неттинг** для доверительных пар. Переход из шлюза через deeplink `start=<short‑token>` с восстановлением контекста компании/роли.

---

## 1) /browse_offers → отклик → сделка (pass‑through)
**Цель:** найти оффер, открыть приватную сделку, провести крипто‑расчёт через кошелёк платформы.

**Шаги**
1. `/browse_offers` → фильтры: пара, сеть (ERC‑20/TRC‑20), режим, объём, дедлайн.
2. Карточки офферов: пара, сеть/токен (USDT/USDC), лимиты, дедлайн, режим, курс. Кнопки: **Откликнуться**, **Подписаться**, **Детали**.
3. **Откликнуться** → подтверждение параметров + **Открыть приватную сделку**.
4. Создаётся `deal: proposed`; в треде сделки бот шлёт чек‑лист: сеть, токен, min‑confirmations, дедлайн.
5. Кнопки: **Отправить реквизиты (банк/крипто)**, **Подтвердить отправку фиата**, **Отправить крипто на адрес платформы** (адрес/QR), **Продлить дедлайн**.
6. При достижении min‑confirmations входящей tx → **«Крипто получено. Авто‑выплата запущена»**.
7. Сообщение о payout (tx‑хэш) → стороны отмечают **Получил (фиат/крипто)** → `deal: completed` + CSV.

**Крайние случаи**: нет tx в дедлайн → предложить **Открыть спор** или **Продлить**; превышение cap → авто‑батчевание/предупреждение; неверная сеть → блокировка кнопки до выбора верной сети.

---

## 2) /new_offer → публикация (deposit‑mode + EOD‑неттинг)
**Цель:** опубликовать оффер с прямыми расчётами под депозит и опциональным дневным неттингом.

**Шаги**
1. `/new_offer` → форма: пара, сеть, сумма, курс/коридор, **режим: deposit‑mode**, дедлайн.
2. Если между компаниями есть **доверительная пара** — переключатель **«Неттинг в EOD»** включён по умолчанию (можно снять для конкретной сделки).
3. Проверка лимитов: `лимит = депозит × k_base`; при нехватке бот показывает доступный максимум.
4. Публикация → подписчики получают нотификацию в @ClubGateBot.
5. Отклик контрагента → `deal: proposed`.

---

## 3) Тред сделки (общие элементы)
- Заголовок: стороны, сеть/токен, сумма, дедлайн (прогресс‑бар), режим (pass‑through / deposit‑mode / **EOD‑неттинг**).
- Таймлайн: `fiat_sent` → `crypto_sent` → `txn_detected` → `txn_confirmed` → `auto_payout_sent` → `received_(fiat|crypto)` → `completed`.
- Инлайн‑кнопки: **Отправить реквизиты**, **Подтвердить отправку/получение**, **Продлить дедлайн**, **Открыть спор**.

---

## 4) EOD‑неттинг в сделке (новое)
**Назначение:** копить сделки между доверительными партнёрами в течение дня и рассчитываться одним платежом в EOD.

**Поведение**
- Переключатель **«Неттинг в EOD»** в шапке сделки (отмечен, если активна доверительная пара).
- При включённом неттинге **авто‑выплата не запускается**; запись уходит в `trust_ledger` текущей дневной сессии пары.
- В треде показывается **виджет дневной позиции**: «Сегодня A↔B: +12 500 USDT (62% лимита). Cut‑off: 18:00 (через 1:15)».
- Кнопки: **Снять из неттинга** (провести как обычную), **/settle_now <partner>** (запросить внеплановый расчёт).

**Проверки**
- Доступ только при **активных депозитах** у обеих компаний.
- Контроль дневного лимита пары; на 90% лимита — блок новых неттинговых сделок.

---

## 5) /deal <id> — состояния и действия
- `proposed` → принять/изменить/отменить.
- `funded`/`in_progress` → подтверждать отправку/получение; в EOD‑режиме — только подтверждения факта (без авто‑выплаты).
- `completed` / `cancelled` / `disputed` → открыть спор/апелляцию.

---

## 6) Ошибки/подсказки (тексты)
- «Выберите сеть (ERC‑20/TRC‑20) и токен (USDT/USDC).»
- «Для pass‑through отправьте **ровно** N USDT на адрес платформы; расхождение ±0.5% — ручная проверка.»
- «Лимит одной сделки сейчас **X USDT** (увеличьте депозит или уменьшите сумму).»
- «Эта сделка проводится в режиме **EOD‑неттинга**. Расчёт в **{cutoff}**.»
- «Достигнуто 90% дневного лимита доверительной пары — новые неттинговые сделки временно запрещены.»

---

## 7) Нотификации
- `offer_new` (в @ClubGateBot), `deal_update` (ключевые события таймлайна), `dispute`.
- **Новые для EOD:** предупреждения за 60/15/5 минут до cut‑off; подтверждение включения/снятия неттинга; статус `/settle_now` (принято в казначейку).

---

## 8) Безопасность
- 2FA обязательна для критичных действий (например, отмена после отправки средств).
- Доступ к EOD‑неттингу — только у компаний с активными депозитами и активной доверительной парой.

---

## 9) Телеметрия/метрики
- Конверсия откликов → сделки, время до auto‑выплаты (pass‑through), доля сделок с EOD‑неттингом, средняя экономия сетевых комиссий, доля запросов `/settle_now` и их успешность.

