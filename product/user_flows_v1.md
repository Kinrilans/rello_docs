# User Flows по функциям (v1) — актуализировано

Цель: зафиксировать **полное пользовательское поведение** по ключевым функциям MVP: кто, где (какой бот), с какими правами, по каким шагам и какие системы задействованы. Это «якорь» для разработки и тест‑кейсов.

Формат каждого сценария: **ID, Название, Бот(ы), Роли, Предусловия, Основной поток, Альтернативы/ошибки, Проверки доступов, Данные/БД, API, События/вебхуки, Аудит/телеметрия, UI заметки.**

> Сети/токены MVP: **TRC‑20**, **USDT/USDC**. Роли: **TRADER / APPROVER / COMPANY_ADMIN / ARBITER / OPS / PLATFORM_ADMIN**. Смежные документы: *Таблица tier’ов (v2), Модуль депозитов и лимитов (v1), Engine авто‑выплат (v1), Deeplink/JWT (v1), API‑контракты (v1), События/вебхуки (v1), Мониторинг и алерты (v1)*.

---

## UF‑00 — Bootstrap платформы и супер‑администратор
**Бот:** @OpsAdminBot → @ClubGateBot  
**Роль:** PLATFORM_ADMIN (супер‑админ)

**Назначение:** создать первого админа платформы и включить режим «только по инвайту».

**Предусловия:** деплой сервиса.

**Основной поток:**
1) В `.env` указать `PLATFORM_ROOT_TG_IDS=123456789,...` **или** сгенерировать одноразовый `setup_code` (TTL 10 мин).  
2) Первый `/start` одним из этих tg_id в @OpsAdminBot → экран инициализации → **Confirm**.  
3) Ставит флаг `settings.invite_only=true`, создаёт `member(root)` с ролью `PLATFORM_ADMIN`.  
4) Супер‑админ может открыть @ClubGateBot и выдавать инвайты.

**Проверки:** tg_id ∈ `PLATFORM_ROOT_TG_IDS` **или** валиден `setup_code`.

**Данные/БД:** `member.platform_roles=["PLATFORM_ADMIN"]` (или таблица `platform_admin`), `settings{invite_only:true}`.

**API:** (внутр.) `POST /platform/bootstrap`.

**UI:** Сообщения «Платформа инициализирована», «Доступ по инвайту включён».

---

## Глобальное правило доступа: invite‑only
**Боты:** все.  
**Правило при `/start` без токена:**
- Если `invite_only=true` **и** пользователь не состоит ни в одной компании **и** нет валидного инвайта → показывать `app.denied` и кнопку «Связаться с админом».  
- Если есть валидный **инвайт‑токен** (`/start <token>` с `scope:["invite:accept"]`) → выполнить соответствующий сценарий UF‑01a/b/c.

**Данные/БД:** `invite(id, type, company_id?, role?, issued_by, target_tg_id?, expires_at, used_at, status)`.

---

## UF‑01a — Инвайт COMPANY_ADMIN для новой компании
**Бот:** @ClubGateBot  
**Кто отправляет:** PLATFORM_ADMIN  
**Кто принимает:** будущий COMPANY_ADMIN

**Предусловия:** включён режим invite‑only.

**Основной поток:**
1) PLATFORM_ADMIN создаёт инвайт `type=company_new_admin` (ввод: имя компании‑черновика, TZ).  
2) Генерируется deeplink (`aud=bot:ClubGate`, `scope:["invite:accept"]`, `ctx:{role:"ADMIN", company_draft:{name,tz}}`).  
3) Кандидат открывает `/start <token>` → проверка токена и (опц.) tg_id.  
4) Мастер онбординга: подтверждает данные → создаются `company`, `member`, `company_member(role=ADMIN)`.  
5) Переход в «Главное меню» компании.

**Ошибки/альтернативы:** токен просрочен/использован; tg_id не совпал; имя занято → предложить изменить.

**БД:** `company`, `member`, `company_member`, `invite(used_at)`.

**API:** `POST /invites` (`type=company_new_admin`), `POST /invites/{id}/accept`, `POST /invites/{id}/revoke`.

**UI:** «Вас пригласили создать и администрировать компанию {name}».

---

## UF‑01b — Инвайт участника в существующую компанию
**Бот:** @ClubGateBot  
**Кто отправляет:** COMPANY_ADMIN  
**Кто принимает:** TRADER / APPROVER / ADMIN

**Основной поток:**
1) COMPANY_ADMIN → «Профиль компании» → «Пригласить участника».  
2) Выбрать роль и (опц.) внутренние лимиты роли (daily/single).  
3) Сгенерировать инвайт `type=company_member` с `company_id`, `role`, `expires_at`, `single_use`.  
4) Кандидат жмёт deeplink → `/start <token>` → подтверждает → создаётся `member` (если не было) и `company_member(role)`.  
5) Активируется выбранная компания; показ «Добро пожаловать».

**Проверки:** приглашает только ADMIN; лимиты роли ≤ лимитов компании.

**БД:** `invite`, `member`, `company_member`.

**API:** `POST /invites` (`type=company_member`) / `accept` / `revoke`.

**UI:** Кнопка «Присоединиться».

---

## UF‑01c — Инвайт партнёрской компании (онбординг в клуб)
**Бот:** @ClubGateBot  
**Кто отправляет:** PLATFORM_ADMIN  
**Кто принимает:** будущий COMPANY_ADMIN партнёра

**Основной поток:**
1) PLATFORM_ADMIN создаёт инвайт `type=company_onboard`.  
2) Принимающий проходит мастер, как в UF‑01a (создаёт свою компанию).  
3) После онбординга — кнопка «Предложить доверительную пару» (deeplink в профиль приглашавшей компании).

**Проверки:** квоты клуба/лимиты; для активации доверительной пары позже потребуется депозит у обеих сторон.

**БД:** `invite`, `company`, `member`, `company_member`.

**API:** `POST /invites` (`type=company_onboard`).

**UI:** Ясный текст про закрытый клуб и invite‑only.

**Требования к токенам инвайтов:** `aud = bot:ClubGate`, `scope=["invite:accept"]`, одноразовый, TTL 72 ч (по умолчанию), опц. привязка к `tg_id`.

---

## UF‑01 — Онбординг компании и выбор активной компании
**Бот:** @ClubGateBot  
**Роли:** любой участник (минимум MEMBER)

**Предусловия:** пользователь приглашён в клуб (allow‑list), есть tg_id.

**Основной поток:**
1) Пользователь жмёт **Start** → экран «Выбор компании».
2) Если компании нет → «Создать компанию»: ввод названия, контакты, TZ.  
3) Устанавливается **активная компания** в сессии; переход в «Главное меню».

**Альтернативы/ошибки:**
- Уже состоит в нескольких компаниях → показывает список с пагинацией.  
- Попытка создать дубликат названия → подсказка «уточните название/ИНН».

**Проверки доступов:** участник должен быть привязан к компании.

**Данные/БД:** `company`, `member`, `company_member`.

**API:** `GET /companies`, `POST /companies` (внутр.), `GET /members?company_id=...`.

**События:** нет (внутренние логи).

**Аудит/телеметрия:** `ui.view`, `ui.click`, `audit_log: company.create / company.switch`.

**UI:** Reply‑меню: Профиль / Реквизиты / Партнёры / Доверительные пары.

---

## UF‑02 — Добавление и верификация крипто‑адреса (allow‑list)
**Бот:** @ClubGateBot  
**Роли:** COMPANY_ADMIN

**Предусловия:** активная компания выбрана.

**Основной поток:**
1) Меню «Реквизиты» → «Добавить адрес».
2) Выбор сети (**TRC‑20**) и токена (**USDT/USDC**).  
3) Ввод адреса → экран подтверждения.  
4) Верификация владельца: метод **подпись** или **микро‑tx**.  
5) Адрес помечается `verified=true` и попадает в **allow‑list**.

**Альтернативы/ошибки:** неверный формат адреса; адрес уже существует; верификация не прошла.

**Проверки:** права COMPANY_ADMIN; лимит на число адресов/день (rate‑limit).

**Данные/БД:** `wallet(id, company_id, network, token, address, verified)`.

**API:** `POST /wallets`, `POST /wallets/{id}/verify`.

**События:** (опц.) `company.wallet.added/verified`.

**Аудит/телеметрия:** запись `audit_log`, метрика `allowlist_size`.

**UI:** Кнопка «Вставить предыдущий адрес»; подсказки формата.

---

## UF‑03 — Просмотр партнёров и их профилей
**Бот:** @ClubGateBot  
**Роли:** TRADER/COMPANY_ADMIN

**Основной поток:**
1) «Партнёры» → лента компаний (поиск/фильтр).  
2) Открыть **карточку партнёра**: статус, сети/токены, tier, доверительные пары (если есть), быстрые CTA: «Предложить сделку» (deeplink в DealDesk), «Запросить доверительную пару».

**API:** `GET /companies`, `GET /trust/pairs?company_id=...`.

**UI:** Карточка, пагинация, кнопка deeplink.

---

## UF‑04 — Запрос доверительной пары (Trust Pair)
**Бот:** @ClubGateBot  
**Роли:** COMPANY_ADMIN

**Предусловия:** обе стороны с активным депозитом (см. лимиты).  
**Основной поток:**
1) Открыть профиль партнёра → «Запросить доверительную пару».  
2) Указать `daily_limit_usd`, `cutoff_local`, `tz`, `reserve_pct` (или дефолт по tier).  
3) Подтвердить → статус `proposed` → уведомление партнёру.  
4) Партнёр **Accept** в своей карточке → пара `active` и резерв удерживается (`reserve_trust`).

**Альтернативы/ошибки:** превышение лимита tier; у одной из сторон нет депозита; попытка создать дубликат пары.

**Проверки:** роли COMPANY_ADMIN у обеих компаний; депозит>0; лимиты/резервы.

**Данные/БД:** `trust_pair`, `deposit_ledger(reserve_trust)`.

**API:** `POST /trust/pairs`, `/trust/pairs/{id}/accept|/pause|/resume`.

**События:** `trust.pair.activated|paused`.

**UI:** Card с параметрами пары; кнопки Accept/Pause/Resume (для владельцев).

---

## UF‑05 — Создание оффера (DealDesk)
**Бот:** @DealDeskBot  
**Роли:** TRADER

**Основной поток:**
1) «Создать оффер» → мастер: сеть (**TRC‑20**), токен (**USDT/USDC**), направление (cash‑in|cash‑out), объём/диапазон, цена/маркап, дедлайн.  
2) Confirm → оффер публикуется.  
3) Оффер виден в ленте.

**Проверки:** cap per‑deal/экспозиция (см. лимиты); внутренние лимиты роли.  
**БД:** `offer`.

**API:** `POST /offers`, `GET /offers`.

**События:** `offer.created`.

**UI:** Шаги 1/4 …; пресеты объёма; сохранение шаблона.

---

## UF‑06 — Принятие оффера и создание сделки
**Бот:** @DealDeskBot  
**Роли:** TRADER

**Основной поток:**
1) В ленте офферов → «Принять» → создаётся `deal(proposed)` между компаниями.  
2) Показывается **DealCard**: параметры сделки, дедлайн, режим.

**Проверки:** повторное принятие (идемпотентность), лимиты/экспозиция.

**БД:** `deal`, `deal_event`.

**API:** `POST /offers/{id}/accept`, `GET /deals/{deal_id}`.

**События:** `deal.created`.

**UI:** Карточка сделки с CTA выбора режима (ниже).

---

## UF‑07 — Режим Pass‑through (входящий → авто‑выплата)
**Боты:** @DealDeskBot (инструкции) + @TreasuryBot (выплата)  
**Роли:** TRADER (+ APPROVER для отправки выплаты)

**Основной поток:**
1) В DealCard выбрать **Pass‑through**.  
2) Показать **адрес pay‑in** платформы (TRC‑20) и сумму.  
3) Пользователь жмёт «Я отправил» → watcher отслеживает подтверждения.  
4) При достижении `min_confirmations` → создаётся `payout_task` контрагенту.  
5) В @TreasuryBot APPROVER видит задачу → **Approve** → **Send**.  
6) На `confirmed` → сделка помечается выполненной.

**Альтернативы/ошибки:** нет подтверждений → таймаут/ретрай; адрес из другой сети; превышение cap per‑tx; недостаток баланса hot.

**Проверки:** allow‑list адреса получателя (контрагента), лимиты компании, приоритет pass‑through.

**БД:** `incoming_tx`, `payout_task`, `deal`.

**API:** `POST /pay-in`, `GET /payouts`, `POST /treasury/payouts/{id}/approve|/send`.

**События:** `pay_in.detected`, `payout.sent|confirmed`, `deal.completed`.

**UI:** Спиннер подтверждений; статусы; кнопка «Открыть в Treasury» (deeplink).

---

## UF‑08 — Включение доверительного неттинга (EOD) для партнёра
**Бот:** @DealDeskBot  
**Роли:** TRADER (в рамках активной доверительной пары)

**Предусловия:** UF‑04 активировал пару; обе стороны с депозитом.

**Основной поток:**
1) В профиле партнёра → «Включить неттинг EOD» (toggle).  
2) Новые сделки с этим партнёром помечаются `is_trusted_netting=true` и **не триггерят авто‑выплату**; суммы попадают в дневную `trust_session`.

**Альтернативы:** при достижении 90% дневного лимита пары — автопауза (см. лимиты) и предупреждение.

**Проверки:** дневной лимит пары, резерв, cap open exposure.

**БД:** `deal(is_trusted_netting)`, `trust_session`.

**API:** `PATCH /deals/{id}` (флаг), `GET /trust/sessions`.

**События:** нет (до закрытия сессии).

**UI:** Тоггл с подсказкой/остатком лимита.

---

## UF‑09 — Закрытие дневной trust‑сессии и EOD‑выплата
**Боты:** @TreasuryBot (ручной запуск выплаты)  
**Роли:** APPROVER / COMPANY_ADMIN

**Предусловия:** есть открытая `trust_session` и сделки дня; наступил cut‑off локального времени пары.

**Основной поток:**
1) Экран «EOD расчёты» → список пар/итогов за сегодня.  
2) Выбрать сессию → показать **net** {payer→payee}.  
3) Нажать «Отправить выплату» → создаётся `payout_task(purpose=eod)`.
4) Подтвердить выплату (**Approve/Send**).  
5) На `confirmed` → `trust_session` = `settled`.

**Альтернативы:** частичная выплата → статус `partial`, остаток переносится **T+1** с приоритетом.

**Проверки:** cap per‑tx, hot баланс, allow‑list, лимиты.

**БД:** `trust_session`, `eod_settlement`, `payout_task`.

**API:** `GET /trust/sessions`, `POST /trust/sessions/{id}/close`, `GET /trust/settlements`.

**События:** `trust.session.closed`, `trust.eod_settlement.sent|confirmed|partial`.

**UI:** Карточка EOD с деталями расчёта; кнопка «Детали ledger».

---

## UF‑10 — Пополнение депозита компании
**Бот:** @TreasuryBot  
**Роли:** COMPANY_ADMIN / APPROVER (видимость)

**Основной поток:**
1) «Адрес депозита» → показать TRC‑20 адрес.  
2) После входящего с `min_confirmations` → `deposit_ledger.deposit_fund` и обновление лимитов.

**Проверки:** сеть/токен; дрейф комиссий учитывается в `fee_adjustment`.

**БД:** `deposit`, `deposit_ledger`.

**API:** `GET /deposits`, (внутр.) `incoming_tx` обработки.

**События:** `deposit.funded`.

**UI:** Копирование адреса; статус «пополнение зачислено».

---

## UF‑11 — Вывод депозита (T+N)
**Бот:** @TreasuryBot  
**Роли:** COMPANY_ADMIN (инициатор) + APPROVER (подтверждает пороговые суммы)

**Предусловия:** `exposure_open = 0`, нет активных споров/несчитанных EOD.

**Основной поток:**
1) «Вывод депозита» → выбрать сумму/адрес из allow‑list.  
2) Confirm + **2FA** (для порога tier).  
3) Создаётся `withdraw_request` и окно **T+N**; после окна — отправка `outgoing_tx`.

**Альтернативы:** в окне T+N открылся спор/новая экспозиция → вывод паузится.

**Проверки:** лимиты, cap, allow‑list, окно T+N.

**БД:** `deposit_ledger(withdraw_request|withdraw_sent)`, `outgoing_tx`.

**API:** `POST /deposits/withdraw`.

**События:** `deposit.withdraw.requested|sent|confirmed`.

**UI:** Чёткий текст рисков и окна T+N.

---

## UF‑12 — Просмотр и отправка payout_task (Treasury)
**Бот:** @TreasuryBot  
**Роли:** APPROVER

**Основной поток:**
1) «Мои выплаты» → список `payout_task` (приоритеты: high/medium/normal).  
2) Открыть карточку → **Approve** (если требуется) → **Send**.  
3) Показать `tx_hash`, статус меняется до `confirmed`.

**Альтернативы/ошибки:** `insufficient_funds`, `invalid_addr`, `fee_too_low`, `network_error` (см. Engine).

**Проверки:** allow‑list, cap per‑tx, лимиты, 2FA.

**БД:** `payout_task`, `outgoing_tx`.

**API:** `GET /payouts`, `POST /treasury/payouts/{id}/approve|/send`.

**События:** `payout.sent|confirmed`.

**UI:** Крупные CTA; предупреждения перед отправкой.

---

## UF‑13 — Открыть спор и загрузить доказательства
**Бот:** @ArbiterDeskBot (создание/ведение), deeplink из DealDesk  
**Роли:** TRADER (инициатор), ARBITER (решение)

**Основной поток:**
1) В DealCard → «Открыть спор» (deeplink в Арбитр).  
2) Выбор типа/сделки → ввод причины/загрузка материалов.  
3) Спор = `open` и попадает в очередь арбитра.  
4) Арбитр запрашивает доп. материалы (опц.), выносит **решение** (`refund|penalty|split|reject`).

**Проверки:** срок подачи спора (48ч), роль.

**БД:** `dispute`, `dispute_evidence`, `dispute_decision`, `deposit_ledger(hold/penalty/refund)`.

**API:** `POST /disputes`, `/disputes/{id}/evidence`, `/disputes/{id}/resolve`.

**События:** `dispute.opened`, `arbiter.decision.posted`.

**UI:** Мастер ввода; статусы; уведомления обеим сторонам.

---

## UF‑14 — Включить/выключить safe‑mode и обработать алёрт
**Бот:** @OpsAdminBot  
**Роли:** OPS/ADMIN

**Основной поток:**
1) Получен алёрт → открыть карточку в боте.  
2) Доступны: **ACK / SNOOZE(15/30/60) / Открыть дашборд / Открыть ранбук**.  
3) При необходимости — включить **safe‑mode** (режим: «stop payouts» / «ERC only» / …).

**Проверки:** роль OPS/ADMIN; логирование всех действий.

**БД:** `audit_log`.

**API:** (внутр.) управление конфигом, `GET /healthz` сервисов.

**События:** `ops.safe_mode.on/off` (опц.).

**UI:** Короткие кнопки; ссылки на Grafana и Runbook.

---

## UF‑15 — Межботные переходы Deeplink (Short‑Token/JWT)
**Боты:** все  
**Роли:** по контексту токена

**Основной поток:**
1) Источник запрашивает **deeplink ticket** для целевого бота с `aud`, `scope`, `ctx` (deal/pair/session).  
2) Пользователь жмёт кнопку → целевой бот получает `/start <token>`, валидирует (TTL, одноразовость, audience, tg_id), поднимает контекст.  
3) Открывается нужный экран (DealCard / EOD / Спор).

**Ошибки:** `token_expired`, `aud_mismatch`, `role_denied`, `tg_mismatch` — дружелюбные тексты и кнопка «Назад» в @ClubGateBot.

**БД:** `deeplink_ticket`, кэш `jti`.

**API:** `POST /deeplink` (внутр.).

**События:** `ui.deeplink.consumed(success|error)` (телеметрия).

**UI:** Никаких сырых токенов в чате; только кнопки.

---

## UF‑16 — Ручная разовая выплата (manual payout)
**Бот:** @TreasuryBot  
**Роли:** APPROVER / COMPANY_ADMIN

**Основной поток:**
1) «Новая выплата» → выбрать адрес из allow‑list, сеть/токен, сумму.  
2) Confirm + 2FA → создаётся `payout_task(purpose=manual)`.
3) Отправка как обычно (**Approve/Send**).

**Проверки:** лимиты/внутренние лимиты роли, allow‑list, cap per‑tx.

**БД:** `payout_task`, `outgoing_tx`.

**API:** `POST /pay-out`, `GET /payouts`.

**События:** `payout.sent|confirmed`.

**UI:** Ясное предупреждение о рисках/неотзывности.

---

## UF‑17 — Шаблон оффера (создать «как прошлый»)
**Бот:** @DealDeskBot  
**Роли:** TRADER

**Основной поток:**
1) «Создать оффер по шаблону» → выбрать прошлый оффер из списка.  
2) Изменить параметры (объём/цена/дедлайн) → Confirm → опубликовать.

**Проверки:** лимиты/экспозиция, дедлайн.

**БД:** `offer`, (опц.) `offer_template`.

**API:** `GET /offers?company_id=...`, `POST /offers`.

**UI:** Кнопка «Как прошлый оффер».

---

## UF‑18 — Карточка EOD: просмотр подробностей ledger
**Бот:** @TreasuryBot  
**Роли:** APPROVER / COMPANY_ADMIN

**Основной поток:**
1) «EOD расчёты» → выбрать пару/дату.  
2) Экран показывает ledger: сделки/корректировки/fees, итог net.  
3) Кнопка «Пересчитать net» (если были корректировки).

**API:** `GET /trust/sessions/{id}/ledger`, `POST /trust/settlements/{id}/recompute`.

**UI:** Сводка + кнопки «Отправить выплату / Пересчитать».

---

## UF‑19 — Отмена сделки
**Бот:** @DealDeskBot  
**Роли:** TRADER (создатель/участник)

**Основной поток:**
1) В DealCard → «Отменить» → выбрать причину → Confirm.  
2) Состояние `cancelled` (или `requires counterparty consent`).

**Проверки:** дедлайн/статус; согласие второй стороны — по правилу оффера/соглашения.

**API:** `POST /deals/{id}/cancel`.

**События:** `deal.updated (cancelled)`.

---

## UF‑20 — Подтверждения по этапам сделки (deal.confirm)
**Бот:** @DealDeskBot  
**Роли:** TRADER

**Основной поток:**
1) В DealCard → «Подтвердить»: `fiat_sent|fiat_received|crypto_sent|crypto_received` с приложением `tx_hash`/документов.  
2) Отмечаем таймлайн, меняем статус, уведомляем вторую сторону.

**API:** `POST /deals/{id}/confirm`.

**UI:** Простой мастер с фото/файлами.

---

## Примечания по тест‑кейсам (как использовать этот документ)
- На каждый UF пишем **минимум 1 E2E** сценарий (см. Тест‑план v1): позитивный + 1–2 негативных.  
- На каждый UF фиксируем **данные/БД** и **события** для трассируемости.  
- По каждому UF прописываем кнопки/тексты из словаря (*Словарь текстов ботов v1*).  
- Если в разработке обнаружены пробелы — правим соответствующие разделы *API‑контракты / Engine / Депозиты / Deeplink* и обновляем этот файл (v1 → v1.1).

