# Диалоговые флоу — @ArbiterDeskBot (v2)

## 0) Контекст
Приватный бот для арбитров/админов платформы. Работает со спорами по обычным сделкам (pass‑through/депозит) и со спорами **trust‑session (EOD‑неттинг)**. Поддерживает сбор/оценку доказательств, вынесение решений (refund/penalty/split/reject), удержания из депозитов и связку с казначейством (выплаты/частичные T+1).

Роли доступа: **Arbiter**, **Admin** (2FA обязательно). Все действия пишутся в `audit_log`.

---

## 1) /cases — очередь споров
**Цель:** видеть все открытые споры и SLA.

**Шаги**
1. `/cases` → фильтры: тип (deal|trust), статус (open|under_review), пара токен/сеть, сумма, давность, компании.
2. Список карточек: `case_id`, `deal_id`, тип, стороны A/B, сумма, причина, **время до SLA**, теги риска (например, «частые опоздания», «cap превышен»).
3. Кнопки: **Взять в работу**, **Назначить коллегу**, **Отклонить (не по правилам)**.

---

## 2) /case <id> — карточка спора
**Цель:** видеть полную картину и управлять ходом рассмотрения.

**Содержимое**
- Шапка: `deal_id`, стороны A/B, режим (pass‑through/депозит/неттинг), сеть/токен, суммы.
- Таймлайн: события сделки (fiat_sent/crypto_sent/txn_detected/txn_confirmed/auto_payout/received), дедлайны.
- Панель «Материалы» (см. /evidence): tx‑хэши, выписки, скрины, видео, заметки.
- Для **trust**‑кейсов: виджет текущей дневной сессии (net‑позиция, лимит, cut‑off, статус `eod_settlement`).

**Действия**
- **Запросить материалы A/B** (шаблонные формы; дедлайн ответа 24ч).
- **Поставить hold** (deposit‑mode): сумма hold ≤ мин(сумма сделки, доступный депозит).
- **Корректировки** (для trust): создать `ledger adjustment` (положительная/отрицательная), инициировать **пересчёт net**.
- **Принять решение** → перейти в `/resolve`.

---

## 3) /evidence <case_id> — материалы
**Цель:** сбор и оценка доказательств.

**Шаги**
1. Лента материалов с типами: `tx_hash | bank_doc | screenshot | video | note | other`.
2. Добавить: файл/ссылка/заметка, привязка к событию или сумме.
3. Быстрые действия: превью блок‑эксплорера по tx‑хэшу, копировать адреса/суммы.
4. Метки качества: «полно», «сомнительно», «неприемлемо».

---

## 4) /resolve <case_id> — вынести решение
**Цель:** оформить итог.

**Шаги**
1. Форма решения: `refund | penalty | split | reject` + сумма (token/USD), получатель (A/B/оба), аргументация.
2. Проверки: доступный депозит нарушителя, cap по спору, арбитражная комиссия.
3. Подтверждение (2FA) → публикация решения в треде сделки + нотификации сторонам.
4. Автопроводки:
   - `deposit_ledger`: `penalty/refund/release/hold` (по ситуации);
   - если нужен payout → создаётся `outgoing_tx` в казначействе (ссылки на tx‑хэш после отправки).

---

## 5) /appeal <case_id> — апелляция
**Цель:** обработать апелляцию с **новыми материалами**.

**Шаги**
1. Карточка апелляции: новые доказательства, причина.
2. Кнопки: **Принять в работу** / **Отклонить (нет новых данных)**.
3. Итоговое решение помечается как `final`.

---

## 6) Trust‑session (EOD‑неттинг) — особые флоу
**Основания спора**: неверная запись в `trust_ledger`, неправильная net‑сумма, просрочка EOD‑оплаты.

**Действия арбитра**
1. Просмотр `trust_session` и `trust_ledger` (список сделок/корректировок за день, суммы, стороны).
2. Создание **корректировки** (adjustment) с комментарием → `/settlements` в казначействе получает триггер «Пересчитать net».
3. По просрочке EOD: вынести решение об удержании из депозита плательщика **+ штраф 0.5–1.5%**; остаток к оплате пометить на **T+1**.
4. При частичной оплате или споре — блокировать остаток до урегулирования (hold в депозите).

---

## 7) SLA и авто‑правила
- Часовой пояс: Europe/Warsaw.
- Открытие спора: ≤ **48ч** (обычные сделки), ≤ **24ч** (trust‑session) после EOD.
- Ответ на запрос/материалы: **24ч**.
- Решение: обычно ≤ **72ч** после полного пакета.
- **Тишина стороны** → решение по умолчанию в пользу другой стороны на базе доступных логов.

---

## 8) Нотификации
- `dispute_opened` — новая карточка.
- `materials_requested` — запросы сторонам.
- `decision_posted` — текст решения + проводки/tx‑хэш (если есть).
- `appeal_submitted` / `appeal_resolved` — статусы апелляции.
- Для trust: `trust_ledger_adjusted`, `trust_net_recalculated`, `eod_settlement_updated`.

---

## 9) Ошибки/ограничения
- «Сумма решения превышает доступный депозит нарушителя» (жёсткое ограничение).
- «Нельзя списать больше суммы сделки/нетто‑позиции».
- «Апелляция без новых материалов — отклонена».

---

## 10) Безопасность и аудит
- Роли Arbiter/Admin, обязательная **2FA**.
- Полный `audit_log` на запросы материалов, корректировки, решения, апелляции; снапшоты карточки до/после решения (hash).

---

## 11) Метрики/телеметрия
- Доля споров по объёму, среднее время до решения, доля апелляций и их исход.
- Для trust: частота корректировок ledger, доля просрочек EOD, средний штраф, % частичных T+1.

