# Диалоговые флоу — @TreasuryBot (v2)

## 0) Контекст
Казначейский бот для компаний с доступом по ролям **Company Admin/Approver** (часть просмотра — **Trader**). Поддерживает депозиты, лимиты, входящие на кошельки платформы для **pass‑through**, разовые выплаты, журнал выплат и **EOD‑расчёты по доверительным парам**. Токены: **USDT/USDC**; сети: **ERC‑20/TRC‑20**. Переход из @ClubGateBot по deeplink `start=<short‑token>`.

---

## 1) /deposit — внести депозит
**Цель:** пополнить депозит компании в USDT/USDC на выбранной сети.

**Шаги**
1. Выбор сети (ERC‑20/TRC‑20) и токена (USDT/USDC).
2. Показ адреса/QR и требований (ровная сумма, учёт комиссии, запрет неверной сети).
3. Статус «Ожидание подтверждений» с прогрессом по `min_confirmations`.
4. По подтверждениям — зачёт депозита, пересчёт `tier/k_base/лимитов`. Нотификация в @ClubGateBot.

**Ошибки/подсказки**
- Неверная сеть/токен — блок отправки.
- Сумма ниже min‑threshold (если задан) — предупреждение.

---

## 2) /withdraw_deposit — запрос на вывод
**Цель:** вывести часть/весь депозит с окном ожидания **T+N** по tier.

**Шаги**
1. Экран: баланс депозита, открытая экспозиция (вкл. **trust‑session hold**), окно T+N.
2. Ввод суммы и адреса (из верифицированных / новый с подтверждением в @ClubGateBot).
3. Подтверждения: **2FA** инициатора + **Approver** при сумме > порога tier.
4. Статус `withdraw_pending` до окончания окна; проверка, что **open exposure = 0** и нет активных споров.
5. Выплата → tx‑хэш → `closed`.

**Ошибки**
- «Есть открытая экспозиция/спор/активный EOD‑неттинг».
- «Превышен дневной cap вывода — попробуйте завтра».

---

## 3) /limits — лимиты и внутренние ограничения
**Цель:** видеть и настраивать лимиты.

**Содержимое**
- Депозит, tier, `k_base`, итоговый лимит (USD экв.), cap одной сделки, суточный cap авто‑выплат, cap открытой экспозиции.
- Вкладка **Доверительные пары**: дневные лимиты по активным парам, текущая загрузка (%), резерв **hold %**.
- Company Admin может задавать **внутренние лимиты** для трейдеров (разовые/дневные).

---

## 4) /tiers — правила tier’ов
Показывает актуальную таблицу S/M/L/XL (мин. депозит, `k_base`, caps, окна T+N, dispute‑hold) и условия доступа к доверительным парам (только при активном депозите у обеих компаний).

---

## 5) /pay_in — входящие для pass‑through
**Цель:** принять крипто под конкретную сделку и привязать входящую транзакцию к `deal_id`.

**Шаги**
1. Выбор `deal_id` из списка `proposed/in_progress` или ввод вручную.
2. Показ адреса/QR платформы, точной суммы, сети/токена, требований «ровной суммы».
3. Трекинг подтверждений → `txn_confirmed` → запуск **auto‑payout**.

**Ошибки**
- «Сумма отличается > ±0.5%» → сигнал мануальной проверки.
- «Сделка не поддерживает pass‑through».

---

## 6) /pay_out — разовая выплата (вне сделки)
**Цель:** оформить выплату из корпоративного баланса (например, возврат, ребаланс, партнёрская выплата).

**Шаги**
1. Форма: сеть/токен, адрес получателя (из allow‑list/новый), сумма.
2. Проверки: дневной cap, cap на транзакцию сети, наличие **Approver** и **2FA**.
3. Статус: `queued` → `signed` → `broadcast` → `confirmed` (tx‑хэш в карточке).

**Ошибки**
- Превышен cap транзакции — авто‑**батчевание**.
- Требуется подтверждение Approver — ожидание.

---

## 7) /payouts — журнал выплат
Список выплат с фильтрами: период, сеть/токен, статус, инициатор, тип (pass‑through/вне сделки/EOD). Кнопки: **CSV**, «Только ошибки», «Только EOD».

---

## 8) **/settlements — EOD‑расчёты по доверительным парам** (новое)
**Цель:** управлять дневными расчётами **нетто‑позиций** A↔B.

**Содержимое**
- Вкладки: **Сегодня / Вчера / Архив**.
- Таблица: пара A↔B, токен/сеть, `net` (в токенах и USD), % загрузки лимита, статус (open/closed/queued/sent/confirmed/partial/failed), ссылки на `trust_session` и `outgoing_tx`.

**Действия**
- **Подтвердить/остановить** EOD‑выплату пары.
- **Пересчитать** (если были корректировки в `trust_ledger`).
- **Разбить батч** (для сетевых cap’ов).
- **Скачать CSV** по сессии.

**Поведение в cut‑off**
- Планировщик по TZ пары закрывает сессию: `open → closed`, считает `net` и создает `eod_settlement`.
- Если **горячая ликвидность** недостаточна — выполняется **частичная оплата**, остаток переносится на **T+1** (приоритетный payout). Алерт казначейству.

---

## 9) /settlement_rules — глобальные правила EOD (новое)
**Настройки**
- Батчинг: max per‑tx cap по сети, пауза между батчами.
- min‑confirmations для EOD‑выплат.
- Резерв **hold %** в депозитах для доверительных пар (по умолчанию 10–20%).
- Порог частичной выплаты и политика T+1.

---

## 10) Нотификации
- `txn_detected/txn_confirmed` — входящие на кошельки платформы.
- `auto_payout_sent` — отправка по pass‑through.
- `withdraw_pending/withdraw_sent` — вывод депозита.
- **Новые (EOD):** `trust_eod_warning (60/15/5 мин)`, `eod_settlement_queued/sent/confirmed/partial/failed`, алерты о недостатке hot‑ликвидности.

---

## 11) Безопасность
- **2FA** обязательно для `/withdraw_deposit` и `/pay_out`.
- Пороговые суммы требуют подтверждения **Approver**.
- Адреса получателей — из **allow‑list**; новые адреса подтверждаются в @ClubGateBot.
- Дедупликация: idempotency‑key на выплаты, уникальность входящих по `(network, tx_hash)`.

---

## 12) Крайние случаи
- Задержки сети — авто‑уведомления, предложение продлить дедлайны сделок в @DealDeskBot.
- Ошибочная сеть/сумма — карточка инцидента, ссылка на `/dispute` в @ArbiterDeskBot.
- Недостаточный горячий баланс — постановка в очередь и **T+1**.

---

## 13) Метрики/телеметрия
- Доля auto‑payout без споров, среднее время подтверждений и выплат.
- Загруженность дневных лимитов по доверительным парам, объём EOD‑неттинга, доля **partial T+1**.
- Ошибки/фейлы выплат, ретраи, потребность в ребалансе hot/cold.

