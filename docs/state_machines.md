# Rello Club — Диаграмма состояний (MVP v1.0)

**Статус:** Черновик (согласованные правила)

Документ фиксирует жизненные циклы ключевых процессов MVP: пополнение RC, вывод RC, сделки B2C/C2B, арбитраж, депозиты (ручные), привязка группы, доставка уведомлений, блокировка после восстановления.

Нотация переходов: `СОСТОЯНИЕ --событие [условие]/действие--> СЛЕД.СОСТОЯНИЕ`.

---

## 1) Пополнение RC (TRC20 → RC)
**Смысл:** клиент отправляет USDT/USDC на одноразовый адрес; ядро проверяет AML и *одновременно с переводом USDT на основной кошелёк сервиса* зачисляет клиента RC (RC ≡ USDT).

### Состояния
- `pending` — создана заявка, выдан одноразовый `deposit_address`, таймер 24ч.
- `funding_detected` — входящий tx обнаружен.
- `aml_checking` — запрос к AML‑провайдеру (GetBlock) с ретраями.
- `aml_high_risk` — адрес высокого риска (ветка возврата).
- `sweep_broadcast` — выполнен перевод с одноразового адреса на `main` (низкий риск); **в этот момент зачисляем RC**.
- `credited` — RC зачислены (финал нормального сценария).
- `refund_sending` — возврат средств отправителю минус комиссия `rc_withdraw_fee_percent`.
- `refund_failed_manual` — авто‑возврат не удался после ретраев; требуется ручное вмешательство.
- `expired` — не профинансировано за 24ч (адрес может быть переиспользован).

### Переходы и таймеры
- `pending --входящий tx--> funding_detected`.
- `funding_detected --старт AML--> aml_checking`.
- `aml_checking --risk=low--> sweep_broadcast / зачислить RC одновременно` → `credited`.
- `aml_checking --risk=high--> aml_high_risk` → `refund_sending` (3 попытки через 5с/30с/180с). При неуспехе → `refund_failed_manual`.
- `pending --24ч без финансирования--> expired`.
- **Таймаут AML:** до 30 мин, ретраи 1/5/15 мин; остаёмся в `aml_checking`, уведомляем модераторов.

### Сайд‑эффекты
- Уведомления: создана заявка, обнаружено поступление, AML‑результат, зачисление RC, возврат/ошибка возврата.
- Идемпотентность: на создание/обновление статуса.

---

## 2) Вывод RC (RC → TRC20)
**Смысл:** с баланса RC отправляем USDT/USDC в сеть TRC20.

### Состояния
- `pending` — создана заявка, зарезервирована сумма RC.
- `aml_checking_dest` — проверка адреса назначения (GetBlock).
- `failed_aml` — адрес назначения high‑risk (финал с ошибкой; клиент создаёт новую заявку с другим адресом).
- `sending` — отправка через CryptoCurrencyAPI.
- `sent` — транзакция отправлена, есть `tx_out_hash/url`.
- `failed` — не удалось отправить (после ретраев или иных ошибок).

### Переходы и таймеры
- `pending --AML dest--> aml_checking_dest`.
- `aml_checking_dest --risk=high--> failed_aml / уведомить клиента`.
- `aml_checking_dest --risk!=high--> sending`.
- `sending --успех провайдера--> sent`.
- `sending --таймауты/ошибки 15 мин, ретраи 60с--> failed / уведомить`.
- **Подмена токена:** при нехватке USDT/USDC разрешена замена на альтернативный (если включено) → отражаем `effective_token`.

### Сайд‑эффекты
- Деблокировка/списание RC, ссылки на tx, Notice о статусах.

---

## 3) Сделка (B2C / C2B)
**Смысл:** эскроу RC внутри сервиса с подтверждениями по фиату между сторонами.

### Общие состояния
- `draft` — инициирована, рассчитаны комиссии, определена сторона холда.
- `held` — RC заморожены у контролируемой стороны (B2C: у продавца; C2B: у клиента).
- `awaiting_fiat` — ожидание отправки фиата плательщиком (таймер 24ч).
- `awaiting_confirmation` — плательщик **уже отправил фиат** и нажал кнопку; ждём подтверждения получения второй стороной (**без тайм‑лимита**).
- `success` — сделка завершена; RC перечислены получателю, комиссии удержаны.
- `cancelled` — отменена до отправки фиата (по таймеру или вручную, если правилами разрешено).
- `arbitration` — спор; решение вручную модератором.

### Ключевые переходы
- `draft --удержать RC--> held`.
- `held --таймер 24ч без отправки фиата--> cancelled / разморозка`.
- `held --плательщик отправил фиат и нажал кнопку--> awaiting_confirmation (таймер снимается)`.
- `awaiting_confirmation --получатель подтвердил--> success / перевод RC`.
- `awaiting_confirmation --возник спор--> arbitration`.
- `arbitration --решение win--> success / перевод RC получателю`.
- `arbitration --решение refund--> cancelled / полная разморозка`.
- `arbitration --решение split--> success / распределение RC 50/50`.

### Сайд‑эффекты
- Notice обо всех шагах; снимки комиссий; журнальные проводки (hold/transfer/refund).

---

## 4) Арбитраж
**Смысл:** ручное разрешение споров администратором (@RelloAdminBot).

### Состояния
- `open` — открыт спор.
- `decided` — вынесено решение (`win | split | refund`).

### Правила
- SLA: автоматического решения нет; напоминания модераторам каждые 12ч.
- Решение фиксирует админ; применяются движения RC по правилам раздела 3.

---

## 5) Депозит (USDT TRC20, ручные операции)
**Смысл:** депозитные счета вне ядра (холодные); внутри — только учёт и заявки.

### Состояния заявки
- `pending` — создана клиентом.
- `approved` — одобрена модератором.
- `rejected` — отклонена.
- `executed` — исполнена вручную, балансы синхронизированы.

### Сайд‑эффекты
- Комиссии из `service_fees` на момент операции; Notice клиенту/работнику.

---

## 6) Привязка группы токеном
**Смысл:** подтверждение компании/продавца и выпуск группового кошелька.

### Состояния
- `token_issued` — токен создан (TTL 2ч, лимит генерации 2/мин/пользователь).
- `token_verified` — токен успешно применён.
- `linked` — группа привязана, создан RC‑кошелёк группы.
- `expired` — токен истёк.

---

## 7) Доставка уведомлений (NoticeBot)
**Смысл:** гарантированная доставка только *новых* сообщений конечным пользователям.

### Состояния
- `pending` — событие принято в outbox ядра.
- `sending` — отправка в NoticeBot.
- `sent` — доставлено (идемпотентность по `notice_id`).
- `failed` — 3 неудачные попытки (задержки 5с/30с/180с), логируем причину.

---

## 8) Блокировка после восстановления доступа
**Смысл:** защита от угонов при перепривязке Telegram ID по токену восстановления.

### Состояния
- `inactive` — блокировки нет.
- `active` — блокировка на 24ч (запрещены: сделки, ввод/вывод RC и депозит).

### Переходы
- `inactive --успешное восстановление--> active`.
- `active --24ч--> inactive` **или** `active --админ OfficeBot--> inactive` (досрочное снятие).

---

## 9) Коды таймеров и политика ретраев (сводно)
- **Пополнение:** ожидание финансирования 24ч; AML — до 30 мин (ретраи 1/5/15 мин).
- **Возврат при high‑risk:** 3 попытки (5с/30с/180с) → `refund_failed_manual`.
- **Вывод:** отправка — до 15 мин, ретраи каждые 60с.
- **Сделка:** таймер 24ч действует **только до** нажатия «отправил фиат».
- **Арбитраж:** напоминания каждые 12ч.
- **Токены групп:** TTL 2ч; лимит генерации 2/мин.
- **Блок после восстановления:** 24ч; досрочное снятие — только главным админом.

---

## 10) Приложение: события Notice (минимум)
- Пополнение: создано, поступление, AML low/high, зачисление, возврат/ошибка возврата.
- Вывод: создано, AML dest ok/high, отправлено, ошибка.
- Сделка: создано, удержание RC, плательщик отправил фиат, подтверждение получателя, отмена по таймеру, арбитраж открыт/решение.
- Депозит: заявка создана/одобрена/отклонена/исполнена.
- Безопасность: создана/снята блокировка 24ч.
- Группа: токен создан/истёк, привязка успешна.

