# Админ‑консоль (v1) — конфигурация, роли, аудит

Цель: единая панель управления платформой (Web + служебный бот @OpsAdminBot). Настройки сетей/кошельков, лимитов и tier’ов, EOD‑неттинга, арбитражных политик, ключей (JWT/Webhooks), наблюдение за очередями выплат и инцидентами, аудит изменений.

---

## 0) Роли и доступ (RBAC)
**Роли платформы**  
- **Platform Admin** — полный доступ; утверждает M‑of‑N критичные изменения.  
- **Treasury Admin** — кошельки, выплаты, капы, fee‑профили, ребаланс.  
- **Risk Admin** — tier/k‑factor, caps/лимиты, стоп‑листы, trust‑правила.  
- **Arbiter Lead** — SLA/штрафные диапазоны, назначение арбитров, ручные корректировки ledger через решения.  
- **Support Ops** — read‑only + инструменты реплея вебхуков/уведомлений, баннеры инцидентов.  
- **Auditor (RO)** — полный просмотр audit/logs/конфигов без права изменений.  
- **DevOps** — ключи/JWKS, вебхуки, RPC/инфраструктура.

**Требования безопасности**: 2FA обязательно; IP allow‑list для Platform/Treasury/Risk; привязка устройств; сессии ≤ 12 ч.

---

## 1) Компании/участники
- Просмотр компаний: статус, tier, `k_base`, лимиты (snapshot), депозит/холды/резервы, активные доверительные пары.  
- Действия: **suspend/unsuspend**, сменить tier/`k_base`, выставить внутренние лимиты (per role/user), сброс 2FA участника.  
- Логи: все изменения → `audit_log`.

---

## 2) Сети и токены
- **Параметры сети**: `min_confirmations_in/out`, `cap_per_tx`, `batch_pause_ms`, резерв газа (ETH/TRX), приоритет fee (`economy|balanced|priority`).  
- RPC‑пулы (primary/backup), health‑чек, переключение.  
- Пресеты по токенам: USDT/USDC (ERC‑20/TRC‑20).

---

## 3) Кошельки (hot/cold) и ребаланс
- Реестр hot‑кошельков: сеть, адрес, баланс token/газ, лимиты, тег (hot‑1/hot‑2).  
- Действия: включить/выключить, **drain/switch**, установка порогов `min_hot_balance`, план ребаланса из cold (мультиподписей, ручное подтверждение).  
- Журнал ребалансов и исходящих `outgoing_tx`.

---

## 4) Engine выплат
- Очереди: глубина/латентность по приоритетам (`high/arbiter/medium/normal`).  
- Политики батчевания и cap per‑tx; карта приоритетов по источникам (pass‑through/EOD/manual/arbiter).  
- Управление `fee_mode` по сети и по очередям; политика stuck_tx (speed‑up/cancel).  
- Операции: ручная остановка/возобновление выплат по сети/кошельку/компании.

---

## 5) Tier’ы и лимиты
- Шаблон tier’ов (S/M/L/XL): `min_deposit`, `k_base`, `cap_per_deal`, `cap_auto_payout_daily`, `cap_open_exposure`, окна **T+N**, пороги **Approver/2FA**.  
- **EOD‑неттинг:** рекомендации по «лимиту пары» и «резерв hold %»; глобальные платформенные cap’ы.  
- Применение: моментально, но новые параметры пары — **со следующей дневной сессии**.

---

## 6) Trust/EOD
- Глобальные правила: `reserve_pct_default`, политика **автопаузы на 90%**, порог частичной оплаты и **T+1**.  
- Управление парами: форс‑пауза/деактивация, изменение лимита, смена TZ/cut‑off (вступает с новой сессии), просмотр `trust_session` и `ledger`.  
- Планировщик: рассинхрон → ручное закрытие `session.close()` и запуск EOD.

---

## 7) Арбитраж/правила
- SLA и окна сроков (обычные 48ч, trust 24ч), диапазоны штрафов (0.5–2.0%), комиссии.  
- Назначение арбитров по очереди; перевод дела; отключение арбитра.  
- Шаблоны решений и запросов материалов (редактируемые).  
- Переключатели «решение по умолчанию при тишине».

---

## 8) Webhooks и события
- Управление endpoint’ами: url, события, секрет, IP allow‑list, статус.  
- Dead‑letter: список не доставленных >24ч, **replay** по диапазону/типам.  
- Подпись HMAC, тайм‑окно, версия событий.  
- Телеметрия доставки: попытки, латентность, ошибки.

---

## 9) Deeplink/JWT ключи
- JWKS: список публичных ключей, `kid`, статусы (active/next/retired).  
- Выпуск/ротация: план смены ключа (dual‑run), срок действия.  
- Кнопка **Emergency**: временно **запретить JWT**, использовать только Short‑Token.  
- Логи в `audit_log` (кто/когда/какой ключ).

---

## 10) Риски, стоп‑листы, адрес‑политики
- Суспенд компаний/пользователей с причиной.  
- Адресные политики: глобальный **blacklist**/локальные allow‑list per company; запрет новых адресов без верификации.  
- Триггеры риска: частота споров, просрочки EOD, превышение cap’ов — **автоснижение k_base** до пересмотра.

---

## 11) Аудит и журналы
- **audit_log**: кто/что/когда/до‑после; экспорт CSV/JSON (для аудитора).  
- Журналы payout‑engine, trust‑сессий, арбитража; трейс‑id.

---

## 12) Мониторинг и алерты
- Дашборды: очереди выплат, ликвидность hot, доля partial/T+1, ретраи вебхуков, ошибки RPC.  
- Алерты: низкий hot‑баланс, рост очередей, stuck_tx, отключенный endpoint, всплеск споров.  
- Интеграции: Pager/Telegram‑канал админов.

---

## 13) Обслуживание/инциденты
- Баннеры статуса: «maintenance», «safe‑mode (EOD off/pass‑through only)», «webhooks degraded».  
- Переключатели safe‑mode: отключить EOD/выплаты по сети, заморозить выводы, включить только read‑only.  
- Change‑freeze окна (запрет изменений в пиковые периоды).

---

## 14) Управление конфигурацией (M‑of‑N, версии)
- Любая критичная смена (tier/k_base, cap per‑tx, ключи, политики риска) идёт по **workflow**: `propose → review → approve (M‑of‑N) → apply`.  
- **config_snapshot**: версия, дифф, кто применил, `applied_at`, возможность **rollback**.  
- Превью‑дифф влияния: какие компании/пары/лимиты затронуты.

---

## 15) API для админки (внутреннее)
- `POST /admin/config/*` — группы настроек (networks/tiers/engine/trust/webhooks/jwks).  
- `POST /admin/replay` — реплей событий/webhooks.  
- `POST /admin/wallets/*` — управление hot‑кошельками.  
- Все — с `Idempotency-Key`, 2FA и записью в `audit_log`.

---

## 16) БД и данные
- `config_snapshot(id, area, version, diff_json, created_by, created_at, approved_by[], applied_at)`  
- `audit_log(id, actor, action, target, before, after, ts, ip, ua)`  
- `ops_banner(id, type, message, active, created_by, created_at)`  
- `risk_flag(company_id, reason, score, created_at)`

---

## 17) UX‑флоу (типовые сценарии)
1) **Поднять cap_per_tx в ERC‑20:** создать предложение → обзор влияния → M‑of‑N approve → apply → лог.  
2) **Добавить hot‑кошелёк TRC‑20:** верификация адреса → установить пороги → включить → тест payout 1 USDT.  
3) **Ротация JWT‑ключа:** добавить `next` ключ → dual‑run 24ч → переключить → retire старый.  
4) **Сдвинуть cut‑off пары:** изменить → пометка «вступит завтра» → уведомить стороны.  
5) **Разрулить dead‑letter вебхуков:** отфильтровать → replay по окну времени.

---

## 18) НФТ (NFR)
- Доступность панелей ≥ 99.9%; сохранность `audit_log` ≥ 365 дней; конфиги — бэкап/restore.  
- Время применения конфиг‑изменений: < 60 сек; откат — < 5 мин.

---

## 19) Связанные документы
- API‑контракты (v1), События/вебхуки (v1), Deeplink/JWT (v1), Engine выплат (v1), Модуль депозитов (v1), Tier’ы (v2), Правила арбитража (v2).

