# Тест‑план (v1) и UAT сценарии — полная версия

Часовой пояс: **Europe/Warsaw**. Токены **USDT/USDC**, сети **ERC‑20/TRC‑20**. Область: все боты, API, payout‑engine, Trust/EOD, арбитраж, админ‑консоль.

---

## 0) Цели и критерии приёмки
- **E2E безошибочно:** P0‑сценарии проходят на prod‑canary.  
- **SLO‑готовность:** p95 pass‑through ≤ **15 мин**; EOD ≤ **60 мин**.  
- **Безопасность:** 2FA/roles, allow‑list адресов, JWT/Short‑Token одноразовые, вебхуки подписаны.  
- **Готовность к инцидентам:** runbooks, алерты, safe‑mode.

**Go/No‑Go чек‑лист** — см. §10.

---

## 1) Матрица тестов (обзор)
| Категория | Подкатегории |
|---|---|
| Боты/UX | Онбординг, инвайты, профили, реквизиты, каталог, сделки, доверительные пары, Inbox |
| Сделки | pass‑through, deposit‑mode, EOD‑неттинг, отмены, продления, споры |
| Treasury | депозит, вывод (T+N), pay‑in/out, журнал выплат, EOD‑расчёты |
| Trust/EOD | пары, дневные сессии, ledger, cut‑off, partial/T+1 |
| Арбитраж | открытие/материалы/решение/апелляция, корректировки ledger |
| API | аутентификация, идемпотентность, пагинация, фильтры |
| Webhooks | подпись/время/ретраи/replay |
| Админ‑консоль | сети/кошельки, tier/лимиты, engine, ключи, safe‑mode |
| Безопасность | 2FA, роли, deeplink/JWT, allow‑list, rate‑limit |
| Надёжность | ретраи payout, stuck‑tx, RPC failover, webhooks dead‑letter |

---

## 2) E2E сценарии (приоритет P0/P1)
### P0‑1 Pass‑through (ERC‑20)
1. Создать оффер → принять → `pay_in` ровной суммы USDT ERC‑20.  
2. Отслеживание `min_conf` → auto‑payout → `received`.  
3. Проверка вебхуков `deal.auto_payout_sent`/`payout.confirmed`.

### P0‑2 Pass‑through (TRC‑20)
Аналогично на TRC‑20, проверка cap per‑tx и энергии/комиссий.

### P0‑3 Deposit‑mode (без неттинга)
Две сделки A↔B с прямыми расчётами; одна с просрочкой → **спор** → решение `refund/penalty` → проводки в `deposit_ledger`.

### P0‑4 Trust/EOD — дневной неттинг
1. Активировать доверительную пару (лимит/резерв/TZ/cut‑off 18:00).  
2. За день — ≥3 сделки с флагом **Неттинг в EOD**.  
3. В cut‑off: `session.closed` → `eod_settlement.sent`/`confirmed`.  
4. Сверка net‑суммы одной выплатой.

### P0‑5 Trust/EOD — partial/T+1
Недостаток hot‑ликвидности → **частичная** выплата; остаток — T+1 (приоритет). Уведомления сторонам.

### P0‑6 Вывод депозита (T+N)
1. `withdraw_request` при `exposure_open=0`.  
2. Окно T+N; попытка начать сделку в окне → отказ.  
3. Выплата и подтверждение.

### P0‑7 Safe‑mode
В админке включить «EOD off, pass‑through only» → проверки блокировок/баннеров/алертов → выключить.

### P1‑1 Арбитраж trust: корректировка ledger
Оспорить запись, внести `adjustment`, пересчитать net, обновить settlement.

### P1‑2 Админ‑ротация ключей JWT/JWKS
Добавить «next», dual‑run, переключить, retire.

---

## 3) Негативные/границы
- Неверная сеть/токен при `pay_in` → отказ и инцидент.  
- Расхождение суммы > ±0.5% → `manual_review`.  
- Превышение лимитов: per‑deal, open exposure, дневной cap → 422.  
- Deeplink: `expired`, `aud_mismatch`, `replay` → корректные ошибки.  
- Webhooks: неправильная подпись/просроченный timestamp → 401/403; ретраи.

---

## 4) Производительность/нагрузка
- Поток сделок: **60/ч** на бота, **10/ч** EOD‑пар; снять p95 latency API/ботов.  
- Батч‑выплаты: 10× по **100k USDT** → подтвердить cap per‑tx/паузы.  
- Webhooks: лавина **1k/мин** (staging) → ретраи <1%.

---

## 5) Безопасность
- 2FA обязательна для критичных действий (вывод/выплаты).  
- Allow‑list адресов: payout на неразрешённый адрес → отказ.  
- Rate‑limit: 10 rps/ключ; бурст → 429.  
- JWT/Short‑Token: TTL, одноразовость, привязка к `tg_id`.

---

## 6) API и вебхуки — контракты
- Схемы JSON валидируются (strict).  
- Идемпотентность POST: повтор с тем же `Idempotency-Key` возвращает тот же объект.  
- Реплей событий: `GET /events` и `POST /webhooks/{id}/replay`.

---

## 7) Данные/сидинг
- 4 компании (S/M/L/XL), депозиты, роли (Admin/Trader/Approver).  
- 2 доверительные пары (ERC‑20/TRC‑20) с разными лимитами и cut‑off.  
- Верифицированные кошельки/счета для каждого участника.

---

## 8) UAT чек‑лист для партнёров
- Отклик на оффер → сделка pass‑through (обе сети).  
- Создание доверительной пары и 3 сделки с неттингом → EOD.  
- Спор по просрочке EOD → решение арбитра.  
- Вывод депозита при нулевой экспозиции.  
- Получение и верификация вебхуков.

**Фидбек‑форма**: UX, тексты/ошибки, скорость, пожелания.

---

## 9) Артефакты и отчётность
- Чек‑листы (pass/fail), скринкасты, логи, вебхуки.  
- Отчёт QA: баги P0/P1/P2, рекомендации, блокеры Go‑Live.

---

## 10) Go/No‑Go чек‑лист

**A. Продукт/функционал**
- [ ] Все **P0‑сценарии** пройдены на prod‑canary (§2). Логи/скринкасты приложены.
- [ ] Негативные/границы (§3) покрыты.

**B. Надёжность/SLO**
- [ ] p95 pass‑through ≤ **15 мин** за последние 7 дней.
- [ ] p95 EOD settlement ≤ **60 мин** за последние 7 дней.
- [ ] Вебхуки ≥ **99%** доставок за 24 часа; dead‑letter = 0.

**C. Безопасность**
- [ ] 2FA **обязательно** для критичных операций.
- [ ] Роли/ACL проверены; внешние ключи/API‑скоупы ограничены.
- [ ] Deeplink **Short‑Token/JWT**: TTL 2–5 мин, одноразовость, привязка к `tg_id` проверены.
- [ ] Allow‑list адресов выплат включён; попытка payout на новый адрес блокируется.
- [ ] Ротация **JWKS** оттестирована (dual‑run → switch → retire).

**D. Treasury/выплаты**
- [ ] Горячие балансы (USDT/USDC + газ ETH/TRX) ≥ `min_hot_balance` по обеим сетям.
- [ ] Cap per‑tx и батч‑паузы настроены.
- [ ] Канареечная выплата **1 USDT** в каждой сети прошла (tx‑хэши приложены).
- [ ] План **ребаланса hot/cold** готов; M‑of‑N работоспособен.

**E. Trust/EOD**
- [ ] Активные пары созданы; лимиты/резервы/cut‑off/TZ корректны.
- [ ] Dry‑run `session.close()` и recompute прошли.
- [ ] Политика **partial/T+1** включена и протестирована.

**F. Операции/мониторинг**
- [ ] Grafana‑дашборды настроены (§2 мониторинга); алерты в Alertmanager активны.
- [ ] On‑call расписание опубликовано; @OpsAdminBot подключён.
- [ ] **Runbooks (v1)** размещены; ссылка добавлена в алерты.
- [ ] **Safe‑mode** проверен (включение/выключение, баннеры, блокировки).

**G. Данные/бэкапы**
- [ ] Политика бэкапов включена; **тест восстановления** выполнен (RPO/RTO зафиксированы).

**H. Легал/документы**
- [ ] Terms/Privacy/MOU — статус согласования понятен (черновик/финал) и подходит для пилота.

**I. Партнёры/UAT**
- [ ] Пилотные партнёры прошли **UAT**; формы фидбека собраны.
- [ ] Контакты эскалации у партнёров подтверждены.

**J. Решение**
- Решение: **GO / NO‑GO** (нужное оставить).  
- Если **NO‑GO** — список блокеров и план действий:
  - [ ] Блокер 1: _______________________ ETA: ____
  - [ ] Блокер 2: _______________________ ETA: ____
- Время решения (UTC+2): ____/____/____, __:__
- Подписи: Platform Admin ____, Treasury Admin ____, Risk Admin ____, QA Lead ____, Pilot Partner ____

---

## 11) Среды тестирования
| Среда | Назначение | Особенности |
|---|---|---|
| **staging** | Функц./нагрузочные, webhooks replay | Тестовые RPC/боты, песочница кошельков |
| **prod‑canary** | E2E с реальными ботами на ограниченной группе | Канареечные кошельки, выплаты 1 USDT, флажок «canary» |

**Телеграм‑боты (test)**: @ClubGateBot‑stg, @DealDeskBot‑stg, @TreasuryBot‑stg, @ArbiterDeskBot‑stg.

---

## 12) Роли и RACI
| Область | Ответственный (R) | Соисполнители (A/C/I) |
|---|---|---|
| Боты/UX | QA Lead | Bot Dev, PM |
| API/вебхуки | QA Lead | BE Dev, Integrations |
| Treasury/выплаты | Treasury Admin | DevOps, QA |
| Trust/EOD | Risk Admin | Treasury, QA |
| Арбитраж | Arbiter Lead | QA |
| Инфраструктура/RPC | DevOps Lead | QA |

---

## 13) График
- **Неделя 0** — сидинг данных, настройка алертов/дешбордов, dry‑run.  
- **Недели 1–2** — внутренний QA (stg).  
- **Неделя 3** — prod‑canary + UAT партнёров.  
- **Неделя 4** — Go/No‑Go и запуск/перезапуск.

---

## 14) Классификация багов и SLA триажа
| Уровень | Описание | SLA реакции |
|---|---|---|
| **P0** | Блокер денег/безопасности | 15 мин, фикса/обход в тот же день |
| **P1** | Серьёзный функционал | 4 ч, фикса ≤ 3 раб. дня |
| **P2** | Минор/UX/тексты | 24 ч, план в спринт |

---

## 15) Инструменты
- **API**: Postman/Newman, pytest.  
- **Нагрузка**: k6/Locust.  
- **Мониторинг**: Grafana/Alertmanager.  
- **Логи/трейсы**: Loki/ELK, OpenTelemetry.  
- **Отчёты**: Allure/Markdown + артефакты в хранилище.

---

## 16) Трассируемость → спецификации
- Каталог функций/флоу (v2), API‑контракты (v1), События/вебхуки (v1), Deeplink/JWT (v1), Engine выплат (v1), Модуль депозитов (v1), Админ‑консоль (v1), Правила арбитража (v2), Tier’ы (v2).

---

## 17) Подписи/Sign‑off
- QA Lead: ____________  Дата: ____  
- Platform Admin: ____________  Дата: ____  
- Treasury Admin: ____________  Дата: ____  
- Pilot Partner (UAT): ____________  Дата: ____

