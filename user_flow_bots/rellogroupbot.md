# @RelloGroupBot — Бот чат‑группы (полный флоу)

> Бот добавляется администратором в Telegram‑группу и работает **внутри группы** с продавцом, клиентом и их работниками. Единый стандарт: вынесены **переменные**, у каждого экрана указан **Режим вывода** (*Новое сообщение / Редактирование / Системное уведомление*), действует **правило актуальности** (после успешных действий удаляем старые экраны с кнопками).

---

## 0) Общие положения

### Роли и проверки
- **Продавец** — владелец сервиса/объявления, к которому привязывается группа.
- **Клиент** — контрагент продавца в группе.
- **Работники продавца/клиента** — пользователи с делегированными правами.
- **Каждое нажатие кнопки** и команда проверяются на право действия: кто нажал (роль), привязан ли к группе, есть ли учётка в Rello.

### Контроль доступа / права бота
- Бот должен быть **администратором** группы (удаление/редактирование сообщений, чтение, управление ссылками).
- Валидации: регистрация в Rello, связь с группой, роль (продавец/клиент/работник), наличие баланса.

### Политика вывода сообщений (дефолт)
- Публичные экранные сообщения в группе — **Новое сообщение** / **Редактирование** текущего.
- Сообщения‑подсказки/ошибки на нажатия кнопок — **Системное уведомление** (`answerCallbackQuery`), чтобы **не засорять чат**.
- Карточки «заявок/сделок» в группе — **Редактирование** текущей карточки.

### Правило актуальности сообщений и кнопок
- После **успешного** ввода/подтверждения бот **удаляет** предыдущий экран с кнопками (`deleteMessage`) и **присылает новое** сообщение/карточку. Это исключает повторные нажатия на устаревшие кнопки.
- Если удаление невозможно — бот **снимает клавиатуру** (редактирование) и на попытки нажатия отвечает `answerCallbackQuery`: «Уже не актуально».
- Ошибки валидации показываются **без удаления**: ждём новый ввод/повтор действия.
- Рекомендовано включать в `callback_data` **версию состояния** экрана и проверять её.

### Переменные
- Пользователи и роли: `{seller}` (например, `@nikname1`), `{client}` (`@nikname2`), `{who_clicked}` — текущий нажимающий.
- Группа: `{group_title}`, `{group_id}`.
- Валюты/суммы: `{fiat_currency}` (ISO 4217 в нижнем регистре), `{fiat_amount}`, `{rc_amount}`.
- Комиссии: `{fee_seller_percent}`, `{fee_service_percent}`; в RC: `{fee_seller_rc}`, `{fee_service_rc}`.
- Балансы/заморозки: `{seller_rc_frozen}`, `{client_rc_frozen}`, `{rc_balance}`, `{rc_frozen}`.
- Заявки/сделки: `{request_id}`, `{deal_id}`, `{opened_at}`.
- Кошельки/сеть: `{token_choice}` (`USDT`/`USDC`), `{trc20_address}`, `{aml_result}`, `{blockchain_tx_link}`.
- Таймауты: `{payment_timeout_hours}` (обычно `24`).

---

## 1) Регистрация группы `/start`

### 1.1. Команда `/start` в группе
- Бот добавлен и имеет права админа. Команду отправляет любой участник.
- Проверяем: есть ли у отправителя учётка в Rello.

**Если отправитель не зарегистрирован**

**Текст**
```
Вы не являетесь членом клуба
```
**Кнопки:** —  
**Ожидаемый ввод:** —  
**Режим вывода:** Новое сообщение

**Если группа уже зарегистрирована и привязана**

**Текст**
```
Группа уже существует и привязана к: {seller}
```
**Режим вывода:** Новое сообщение

**Если группа не зарегистрирована** — показываем экран «Регистрация группы»:

**Текст**
```
Rello Group Bot — бот для работы в закрытом клубе Rello.
Зарегистрировать группу можно по токену из вашего профиля.
```
**Кнопки:** `Зарегистрировать группу`  
**Режим вывода:** Новое сообщение

#### 1.1.1. Кнопка «Зарегистрировать группу»
- Проверяем, что нажал **зарегистрированный** пользователь; иначе —

**Системное уведомление**
```
Вы не имеете доступа
```

- Если доступ есть — просим токен:

**Текст**
```
Введите одноразовый токен
```
**Ожидаемый ввод:** Токен (валиден 1 час)  
**Режим вывода:** Редактирование

- Просрочен → **Новое сообщение**: «Токен больше не валиден, запросите новый токен.»
- Валиден → регистрируем группу за **продавцом**, удаляем прежний экран и шлём **новый**:

**Текст**
```
Группа зарегистрирована, {seller} (продавец).
Установлены комиссии по умолчанию:
B2C (Фиат→Крипто) — 15%
C2B (Крипто→Фиат) — 15%

Измените значения в главном боте в разделе «Работа вне сервиса».
```
**Режим вывода:** Удаление + Новое сообщение

Затем отправляем **приветствие**:
```
Для начала сделок требуется регистрация клиента, ответственного за оплату. Он должен отправить команду /registr.
```
**Режим вывода:** Новое сообщение

---

## 2) Регистрация пользователей в группе `/registr`

Команду может отправить **любой** участник группы. Бот определяет статус пользователя.

### 2.1. Пользователь **не зарегистрирован** в Rello (внешний клиент)

**Текст**
```
Вы не являетесь клиентом клуба Rello. После подтверждения продавца группе будет предоставлен индивидуальный кошелёк, а вам — права на его пополнение и вывод RC в USDT/USDC (TRC20).

1 RC = 1 USD

{seller} (продавец), вы подтверждаете {client} (клиента) ответственным за сделки и расчёты в этой группе?
```
**Кнопки:** `Подтверждаю` / `Не подтверждаю`  
**Режим вывода:** Новое сообщение

- Нажимать эти кнопки может **только продавец**. Иначе —

**Системное уведомление**: «Вы не продавец и не можете совершить действие»

- Отказ →
```
Продавец не подтвердил ответственного.
```
- Подтверждение → создаём **отдельный кошелёк группы** (RC) и редактируем сообщение:
```
Новый кошелёк для группы успешно создан.
{client}, вы можете пользоваться кошельком в рамках данной группы.

Посмотреть возможности — /info
Создать сделку — /deal_<b2c\c2b>_<сумма>_<валютаISO>, напр. /deal_b2c_1000_eur
Вывод средств — /send_<usdt/usdc>_<адрес>_<сумма>, напр. /send_usdt_Truie3284102315hjfs87_1000
Пополнить кошелёк — /cash_<сумма>_<usdt\usdc>, напр. /cash_1000_usdt
Открытые сделки — /deal_open
Баланс — /balance
Статистика — /stat_<дней>, напр. /stat_2
Выписка CSV — /stats_<дд.мм.гг>_<дд.мм.гг>, напр. /stats_12.11.25_01.02.26 (макс. 1 год)
Поддержка — @RelloSupport. Язык — /lang
```

### 2.2. Пользователь **зарегистрирован** в Rello
- Если это **продавец** —
```
Вы не можете быть и клиентом
```
- Иначе — просим подтверждение у продавца:
```
Для привязки к группе требуется подтверждение продавца.
{seller}, вы подтверждаете работу с {client}?
```
**Кнопки:** `Подтверждаю` / `Не подтверждаю`

- Логику нажатий и исходы — как в п. 2.1. При подтверждении:
```
{seller} (продавец) и {client} (клиент) привязаны к группе, можно совершать сделки в обе стороны.

(далее — те же подсказки по командам)
```

---

## 3) Инфо `/info`
**Текст**
```
Что может этот бот:
— Создание сделок: /deal_<b2c\c2b>_<сумма>_<валютаISO>
— Вывод средств: /send_<usdt/usdc>_<адрес>_<сумма>
— Пополнение кошелька: /cash_<сумма>_<usdt\usdc>
— Открытые сделки: /deal_open
— Баланс: /balance
— Статистика: /stat_<дней>
— Выписка CSV: /stats_<дд.мм.гг>_<дд.мм.гг>
— Сменить язык: /lang
Поддержка — @RelloSupport
```
**Режим вывода:** Новое сообщение

---

## 4) Открытие сделки **B2C** `/deal_<b2c\c2b>_<сумма>_<валютаISO>`
**Доступ**: только клиент (и его работники). Подтверждение — у продавца/его работников.

### 4.0. Валидации команды
- Формат неправильный →
```
Команда введена некорректно. Нужно: /deal_<b2c\c2b>_<сумма>_<валютаISO>, напр. /deal_b2c_1000_eur
```
- Неизвестная валюта →
```
Валюта не найдена. Проверьте список ISO 4217 и повторите команду. Если проблема повторится — @RelloSupport
```

### 4.1. Подготовка сделки B2C (клиент получает фиат, продавец платит RC)
- Рассчитываем курс `{fiat_currency}/USDT`, считаем `{rc_amount}`, комиссии и итог к заморозке у **продавца**.
- Отправляем карточку в группу:

**Текст**
```
Подтвердите открытие B2C сделки
Клиент {client} хочет начать сделку.

Валюта и сумма: {fiat_amount} {fiat_currency}
Сумма в RC: {rc_amount}
Комиссия продавца: {fee_seller_rc} RC — {fee_seller_percent}%
Комиссия сервиса: {fee_service_rc} RC — {fee_service_percent}%

{seller} (продавец) к оплате: … RC
{client} (клиент) к получению: … RC
```
**Кнопки:** `Подтвердить` / `Отменить`  
**Режим вывода:** Новое сообщение  
Параллельно — уведомление в @RelloNoticeBot продавцу и его работникам.

#### 4.1.1. «Подтвердить» (нажимают продавец/работник)
- Иначе → **Системное уведомление**: «Вы не являетесь продавцом или его работником»
- Проверяем баланс продавца; если недостаточно → **Системное уведомление**: «Недостаточно средств, пополните RC и повторите»
- Иначе — замораживаем RC у продавца и **редактируем** карточку:
```
Сделка B2C подтверждена
Номер сделки: #{deal_id}

Валюта и сумма: {fiat_amount} {fiat_currency}
Сумма в RC: {rc_amount}
Комиссия продавца: {fee_seller_rc} RC
Комиссия сервиса: {fee_service_rc} RC

{seller}, у вас заморожено: … RC
Когда получите средства — подтвердите закрытие.
В случае споров — @RelloSupport или подайте на арбитраж.
```
**Кнопки:** `Подтвердить` / `Отправить на арбитраж`

##### 4.1.1.1. «Подтвердить» (финальное)
- Доступ: продавец/работник. Иначе — **Системное уведомление**.
- Закрываем сделку успешно, переводим замороженные RC клиенту, **редактируем** карточку:
```
Сделка B2C завершена успешно
Номер сделки: #{deal_id}

{client} — вам зачислено … RC
```
- Уведомления в @RelloNoticeBot продавцу и клиенту: списано/зачислено, баланс, ссылка (если есть).

##### 4.1.1.2. «Отправить на арбитраж»
- Доступ: клиент/его работник. Иначе — **Системное уведомление**: «Вы не клиент»
- Подтверждение:
```
Сделка #{deal_id}
Точно подать на арбитраж? После подачи нельзя закрыть сделку самостоятельно.
```
**Кнопки:** `Назад` / `Подтвердить`
- После подтверждения — создаём заявку арбитража; далее исходы модератора:
  - **Успешно** — «Сделка успешно завершена. Средства … RC зачислены.»
  - **Возврат** — «Сделка закрыта арбитром. Средства возвращены.»
  - **Поровну** — «Сделка закрыта арбитром. Вам начислена половина средств.»

#### 4.1.2. «Отменить»
- Доступ: продавец/работник. Иначе — **Системное уведомление**: «Вы не клиент/продавец или его работник»
- Отмена → сообщение: «Сделка отменена».

---

## 5) Открытие сделки **C2B** (клиент платит RC, продавец отдаёт фиат)

### 5.0. Валидации — как в п. 4.0.

### 5.1. Подготовка сделки C2B
- Валидируем валюту, проверяем **баланс клиента**; если недостаточно — сообщение:
```
{client}, у вас недостаточно средств. Пополните RC и повторите попытку.
```
- При успехе замораживаем RC у клиента и отправляем карточку:
```
Подтвердите открытие C2B сделки
Клиент {client} хочет начать сделку.

Валюта и сумма: {fiat_amount} {fiat_currency}
Сумма в RC: {rc_amount}
Комиссия продавца: {fee_seller_rc} RC — {fee_seller_percent}%
Комиссия сервиса: {fee_service_rc} RC — {fee_service_percent}%

{client} к оплате: … RC
{seller} к получению: … RC
```
**Кнопки:** `Подтвердить` / `Отменить`  
Параллельно — уведомление в @RelloNoticeBot продавцу/работникам.

#### 5.1.1. «Подтвердить» (нажимают продавец/работник)
- Иначе — **Системное уведомление**.
- **Редактируем** карточку на подтверждённую:
```
Сделка C2B подтверждена
Номер сделки: #{deal_id}

... (параметры сделки)

{client}, у вас заморожено: … RC
Когда получите средства — подтвердите закрытие.
В случае споров — @RelloSupport или арбитраж.
```
**Кнопки:** `Подтвердить` / `Отправить на арбитраж`

##### 5.1.1.1. «Подтвердить» (финальное)
- Доступ: **клиент/его работник**. Иначе — **Системное уведомление**.
- Закрываем сделку успешно, переводим замороженные RC продавцу, **редактируем** карточку:
```
Сделка C2B завершена успешно
Номер сделки: #{deal_id}

{seller} — вам зачислено … RC
```
- Уведомления обеим сторонам в @RelloNoticeBot.

##### 5.1.1.2. «Отправить на арбитраж»
- Доступ: продавец/его работник. Иначе — **Системное уведомление**: «Вы не продавец»
- Подтверждение и подача — как в п. 4.1.1.2. Карточка дополняется строкой: «Сделка подана на арбитраж, свяжется @RelloSupport».

#### 5.1.2. «Отменить»
- Доступ: продавец/работник. Иначе — **Системное уведомление**. Отменяем и сообщаем: «Сделка отменена».

---

## 6) Вывод средств `/send_<usdt/usdc>_<адрес>_<сумма>`
**Доступ**: клиент и продавец (и их работники для подтверждений по месту).

### 6.0. Валидации
- Формат неверный →
```
Команда введена некорректно. Пример:
/send_usdt_{TRC20-адрес}_1000
```
- Нет прав (не клиент и не привязан к группе) →
```
Вы не являетесь клиентом и не можете выводить средства группы
```
- Недостаточно средств → «Недостаточно средств»
- Адрес не TRC20/неподходящего токена → «Адрес некорректен, проверьте ввод»

### 6.1. Подтверждение вывода
```
Сумма к выводу: … {token_choice}
Комиссия вывода: 0.5% (мин. 10 USDT)
Токен/сеть: {token_choice} TRC20
Кошелёк: {trc20_address}
```
**Кнопки:** `Подтвердить вывод` / `Отмена`  
**Режим вывода:** Новое сообщение

- «Подтвердить вывод» — проверяем, что нажал **инициатор**; иначе — **Системное уведомление**: «Это не ваш запрос». При успехе — карточка «Заявка #{request_id} … Ожидайте подтверждения». Дальше:
  - **Автоматический режим** — финансовое ядро отправляет средства: при ошибке — сообщение с логом; при успехе — сообщение в группу и дублирование в @RelloNoticeBot с **ссылкой на блокчейн**.
  - **Ручной режим** — создаётся заявка админам; после обработки — те же сообщения об успехе/ошибке.

---

## 7) Пополнение кошелька `/cash_<сумма>_<usdt\usdc>`
**Доступ**: клиент и продавец.

### 7.0. Валидации
- Неверный формат →
```
Команда введена некорректно. Пример: /cash_1000_usdt
```
- Нет прав (не клиент и не привязан) → «Вы не являетесь клиентом и не можете пополнять кошелёк группы»

### 7.1. Подтверждение
```
Сумма пополнения: … USDT
Комиссия пополнения: 0.5%
Токен: {token_choice}
К отправке: … {token_choice}
Подтвердить?
```
**Кнопки:** `Подтвердить` / `Отмена`

- «Отмена» → уточнение и «Пополнение отменено».
- «Подтвердить» (только инициатор) → создаём заявку #{request_id}, карточка «Ожидайте подтверждения». Далее:
  - **Автоматический режим** — выдаём `{trc20_address}`, ждём платёж и AML. Таймаут `{payment_timeout_hours}` часов → отменяем. AML high‑risk → возврат с комиссией и текст с `{aml_result}`. AML ok → зачисление RC, сообщение «Успешно выполнена» (в группу и, если кошелёк личный, в @RelloNoticeBot).
  - **Ручной режим** — заявка админам: отмена/подтверждение → карточки как выше; «Подтвердить оплату» помечает «Ожидайте подтверждения модератором».

---

## 8) Список открытых сделок `/deal_open`
**Доступ**: клиент, продавец и их работники.

- Если нет — «Открытые сделки отсутствуют».
- Если есть —
```
Открытые сделки:
B2C: N
C2B: M
```
**Кнопки:** список вида «B2C EUR 10000», пагинация. Выбор — отправляем **карточку сделки**, по возможности удаляя старое сообщение.

---

## 9) Баланс `/balance`
**Доступ**: клиент, продавец и их работники.

Кнопка `Посмотреть баланс` →
- Если нет прав — **Системное уведомление**: «Нет доступа»
- Иначе — **Системное уведомление** с:
```
Баланс: {rc_balance} RC
Заморожено: {rc_frozen} RC
```

---

## 10) Статистика завершённых сделок `/stat_<дней>`
**Доступ**: клиент, продавец и их работники.

- Неверный формат → «Команда введена некорректно…»
- Нет прав → «У вас нет доступа к запросу статистики»
- Успех → сообщение:
```
Всего сделок:
B2C: … на сумму (… RC)
C2B: … на сумму (… RC)
```

---

## 11) Выписка CSV за период `/stats_<дд.мм.гг>_<дд.мм.гг>`
**Доступ**: клиент, продавец и их работники (макс. 365 дней).

- Неверный формат → подсказка формата.
- Нет прав → «У вас нет доступа к запросу статистики»
- Успех → формируем CSV и отправляем в чат: `GroupDeal{date_from}-{date_to}.csv`

---

## 12) Сменить язык `/lang`
**Доступ**: клиент, продавец и их работники.

**Текст**
```
Выберите язык данной группы
Установлено — Русский
```
**Кнопки:** `Назад` / `Русский` / `English`
- Если выбран уже установленный — **Системное уведомление**: «Данный язык уже установлен».
- Иначе — меняем язык **только для этой группы** (по умолчанию берётся язык в @RelloClubBot), **Системное уведомление**: «Язык успешно изменён».

---

## 13) Технические заметки
- Все клики сопровождаются `answerCallbackQuery` (ошибки/подтверждения), чтобы не спамить группу.
- Карточки сделок редактируются; успешные шаги приводят к удалению старых сообщений с кнопками (или снятию клавиатуры).
- Все суммы в RC — целые; адреса — TRC20; валюты — ISO 4217; период CSV — ≤ 365 дней.
- Интеграции: @RelloNoticeBot (уведомления), финансовое ядро (кошельки/AML), @RelloAdminBot (ручная обработка), @RelloTopicsBot (связанные объявления), @RelloClubBot (кабинет клиента).

