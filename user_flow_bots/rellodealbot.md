# @RelloDealBot — Одиночные сделки (полный флоу)

> Полная спецификация бота транзакций. Соответствует стандарту Rello‑доков: вынесены **переменные**, у каждого экрана указан **Режим вывода** (*Новое сообщение / Редактирование / Системное уведомление*). Действует **правило актуальности** (после успешных действий удаляем старые экраны с кнопками или снимаем клавиатуру и отвечаем «Уже не актуально»).

---

## 0) Общие положения

### Назначение
`@RelloDealBot` проводит **одиночные сделки** между клиентом и продавцом (владельцем сервиса). Заявки приходят из объявлений (@RelloTopicsBot). Работа возможна **в личных сообщениях** и **в рабочей чат‑группе**.

### Роли
- **Продавец** — владелец сервиса (и его **работники**).
- **Клиент** — участник клуба, инициирующий сделку.

### Контроль доступа
- Все действия проверяются на: регистрацию в Rello, роль, связь с сервисом/группой, доступность балансов.

### Политика вывода сообщений (дефолт)
- Команды (`/start`, `/menu`, `/info`) → **Новое сообщение**.
- Навигация/формы внутри экрана → **Редактирование** текущего сообщения.
- Ошибки/подсказки по кликам — **Системное уведомление** (`answerCallbackQuery`).
- Карточки сделок — **Редактирование** (одна карточка на сделку в текущем контексте).

### Правило актуальности сообщений и кнопок
- После **успешного** шага (валидный ввод, подтверждение) **удаляем** предыдущий экран с кнопками (`deleteMessage`) и **присылаем новое** сообщение/карточку.
- Если удалить невозможно — **снимаем клавиатуру** (редактирование) и на дальнейшие нажатия отвечаем: «Уже не актуально».
- Ошибки валидации показываем **без удаления**: ждём новый ввод.
- Рекомендация: в `callback_data` хранить **версию состояния** экрана (anti‑race).

---

## Переменные
**Пользователи и связи**: `{seller}` (напр. `@nickname1`), `{client}` (`@nickname2`), `{is_worker}` (bool)

**Объявление**: `{ad_id}`, `{ad_title}`, `{ad_link}`, `{range_min_rc}`, `{range_max_rc}`, `{ad_currencies}` (ISO 4217), `{ad_b2c_percent}`, `{ad_c2b_percent}`

**Сделка**: `{deal_id}`, `{direction}` (`B2C`/`C2B`), `{fiat_currency}`, `{fiat_amount}`, `{rc_amount}`, `{fee_seller_percent}`, `{fee_service_percent}`, `{fee_total_rc}`, `{created_at}`, `{expires_min}` (обычно `60`)

**Баланс**: `{client_rc_balance}`, `{seller_rc_balance}`, `{rc_frozen_client}`, `{rc_frozen_seller}`

**Реквизиты** (C2B получает клиент): `{beneficiary}`, `{address}`, `{iban}`, `{bank_name}`, `{account_owner}`, `{age}`, `{country}`

**Файлы/медиа**: лимит `{file_max_mb}`=`10`, допустимые типы: `.PDF/.JPG/.PNG`

**Служебные**: `{group_id}`, `{send_to}` (`ЛС`/`Группа`), `{timeout_hours}`=`24`

---

## 1) Вход `/start`

### 1.1. Личные сообщения
- Если пользователь **не зарегистрирован**:

**Текст**
```
Вы не состоите в закрытом клубе Rello
```
**Режим вывода:** Новое сообщение

- Если зарегистрирован:

**Текст**
```
С возвращением, {client}
```
**Режим вывода:** Новое сообщение → затем **Главное меню**

### 1.2. В группе
- Не зарегистрирован → «Вы не состоите в закрытом клубе Rello» *(Новое сообщение)*
- Если у пользователя **закреплена другая рабочая группа**:

**Текст**
```
У вас есть другая группа в качестве рабочей, хотите заменить на эту?
```
**Кнопки:** `Да` / `Нет`  
**Режим вывода:** Новое сообщение

`Да` → заменить ID рабочей группы, **Редактирование**:
```
Группа сделана рабочей, все новые сделки будут поступать в новую группу
```
`Нет` → **Редактирование**: «Действие отменено, если передумаете — введите /start»

- Если рабочая группа **не была установлена**:

**Текст**
```
Хотите закрепить данную группу как основную рабочую?
```
**Кнопки:** `Да` / `Нет`  
`Да` → добавить ID, **Редактирование**: «Группа сделана рабочей…»  
`Нет` → **Редактирование**: «Действие отменено…»

---

## 2) Главное меню `/menu`
**Текст**
```
Открытые сделки: …
Завершённых сделок: …
Работники: …
```
**Кнопки:** `Активные сделки` / `История сделок` / `Инфо`  
**Режим вывода:** Новое сообщение → далее Редактирование

---

## 3) Инфо `/info`
**Текст**
```
Rello Deal предназначен для работы со сделками.
Если работаете один — используйте личные сообщения с ботом.
Если есть работники: создайте рабочую группу, добавьте @RelloDealBot админом,
попросите работников ввести /registr.
Управление настройками — в @RelloClubBot («Мой офис»).
```
**Режим вывода:** Новое сообщение

---

## 4) Регистрация работников `/registr` (только в группе)
- В ЛС → **Новое сообщение**: «Данное действие доступно только в чат‑группе, сделанной рабочей»
- В группе, если группа **не рабочая** → «Группа не является рабочей… Введите /start у владельца» *(Новое сообщение)*
- Если группа **рабочая** → закрепляем работника за владельцем, **Новое сообщение**:
```
Регистрация работника {client} прошла успешно. Теперь вы можете обрабатывать сделки.
Для уведомлений о новых заявках запустите @RelloNoticeBot.
```
Отправить владельцу уведомление в @RelloNoticeBot: «В группе {title} зарегистрировался работник…»

---

## 5) Одиночная сделка (инициирует клиент из @RelloTopicsBot)
После клика по кнопке «Одиночная сделка» под объявлением — открывается мастер в @RelloDealBot.

### 5.1. Экран выбора типа сделки
**Текст**
```
Создать одиночную сделку с сервисом: {seller}
По объявлению: {ad_title} (ссылка в заголовке)
Диапазон: {range_min_rc} RC — {range_max_rc} RC
Выберите тип сделки
```
**Кнопки:** `C2B (крипто→фиат)` / `B2C (фиат→крипто)` / `Назад`  
**Режим вывода:** Новое сообщение

---

### 5.1.A. Ветвь C2B (клиент платит RC → получает фиат)

#### A1. Выбор валюты
**Текст**
```
Выберите валюту, которую хотите получить
```
**Кнопки:** `Назад` / список валют из объявления (пагинация по 10)  
**Режим вывода:** Редактирование

#### A2. Ввод суммы (в RC)
**Текст**
```
Введите сумму сделки в RC: от {range_min_rc} до {range_max_rc}
```
**Кнопки:** `Назад` / `Ввести в выбранной валюте`  
**Ожидаемый ввод:** сумма (целое число)

`Ввести в выбранной валюте` → показать курс `{fiat_currency}/RC` (1 RC = 1 USDT), пересчитать диапазон в валюте, **Редактирование** экрана ввода суммы в валюте. Ввод в валюте → переводим в RC и возвращаемся к проверкам как при вводе RC.

**Валидации суммы**
- Неверный формат → **Редактирование**: «Сумма введена некорректно…»
- Вне диапазона → **Редактирование**: «Сумма должна быть в диапазоне…»
- Недостаточно средств у клиента → **Редактирование**: «Недостаточно средств, максимум {client_rc_balance} RC»

**Успех** → **Удаление + Новое сообщение** «Введите реквизиты получения»:
```
Введите данные получения средств:
- Beneficiary
- Адрес
- IBAN
- Название банка
- Владелец счета
- Возраст
- Страна
```
**Ожидаемый ввод:** текст реквизитов  

#### A3. Подтверждение создания
После ввода реквизитов — **Удаление + Новое сообщение** (превью):
```
Подтвердите создание сделки
Продавец: {seller}
Валюта и сумма: {fiat_amount} {fiat_currency}
Сумма в RC: {rc_amount}
Комиссия продавца: {fee_total_rc} RC
К отправке: {rc_amount + fee_total_rc} RC

Реквизиты:
<введённые реквизиты>
Открыть сделку?
```
**Кнопки:** `Назад` / `Отменить` / `Подтвердить`

`Отменить` → диалог подтверждения → «Сделка отменена» *(Редактирование)*

`Подтвердить` →
- Проверка актуальности объявления и диапазона (если изменился и сумма вне диапазона — предложение «Ввести сумму заново»)
- При успехе: замораживаем RC у **клиента**, создаём сделку, **Редактирование**:
```
Сделка #{deal_id}
Запрос отправлен продавцу. Ожидайте ответа.
Если продавец не ответит в течение {expires_min} минут — сделка будет аннулирована.
```

#### A4. Решение продавца
- **Отмена продавцом** → клиенту **Новое сообщение**: «Сделка #{deal_id} отменена. Причина: <комментарий>»
- **Принятие продавцом** → клиенту **Новое сообщение**:
```
Сделка #{deal_id} подтверждена
Ожидайте оплаты по предоставленным реквизитам
```
**Кнопки:** `Написать продавцу`

#### A5. Сообщения по сделке (клиент↔продавец)
- **Кнопки:** `Написать продавцу` / `Ответить`
- Экран ввода: «Введите сообщение или отправьте файл (.PDF/.JPG/.PNG) до {file_max_mb} МБ» + `Отменить`
- Валидации: размер/формат; успех → **Новое сообщение**: «Сообщение отправлено». Уведомить вторую сторону.

#### A6. Оплата продавцом → подтверждение клиентом
После уведомления «Сделка оплачена, проверьте… (чек при наличии)» у клиента кнопки:
`Подтвердить получение` / `Подать на арбитраж`.

- **Арбитраж**: если уже в арбитраже — **Системное уведомление**; иначе показать подтверждение подачи → «Сделка отправлена на арбитраж…»; **убрать все кнопки** у карточки сделки у обеих сторон.
- **Подтвердить получение** → подтверждение необратимости → при согласии: **успешное закрытие**, перевод RC продавцу, экран «Сделка завершена. Оцените качество» + кнопки `Отлично/Нормально/Плохо` → «Ваша оценка сохранена» (редактирование).

---

### 5.1.B. Ветвь B2C (клиент получает фиат от продавца; продавец платит RC)

#### B1. Выбор валюты → ввод суммы (аналогично A1–A2)
- Валидации суммы: формат/диапазон.
- Проверка **баланса продавца** при подтверждении (ниже). При недостатке — **Системное уведомление** продавцу: «Недостаточно средств, пополните RC».

#### B2. Подтверждение создания клиентом
**Текст (превью)**
```
Подтвердите создание сделки
Продавец: {seller}
Валюта и сумма: {fiat_amount} {fiat_currency}
Сумма в RC: {rc_amount}
Комиссия продавца: {fee_total_rc} RC
К получению клиентом: {rc_amount - fee_total_rc} RC
Открыть сделку?
```
**Кнопки:** `Назад` / `Отменить` / `Подтвердить`

`Подтвердить` → проверка актуальности объявления/диапазона. При успехе — создаём сделку, **Новое сообщение** клиенту:
```
Сделка #{deal_id}
Запрос отправлен продавцу. Ожидайте ответа.
Если продавец не ответит в течение {expires_min} минут — сделка будет аннулирована.
```

#### B3. Решение продавца
Продавцу приходит карточка «Запрос сделки … Принять?» с кнопками `Отменить` / `Принять`.
- `Отменить` → ввод причины → закрыть с уведомлениями.
- `Принять` → **проверка баланса продавца**, при успехе — **заморозка RC у продавца**, запрос реквизитов для оплаты клиенту; после ввода — подтверждение реквизитов и ожидание **подтверждения оплаты клиентом** (кнопка «Подтвердить оплату» с прикреплением чека `.PDF/.JPG/.PNG` ≤ {file_max_mb} МБ, либо «Подтвердить без чека»).

#### B4. После подтверждения оплаты клиентом
Продавцу карточка:
```
Сделка #{deal_id}
Сделка оплачена клиентом. Проверьте и подтвердите получение.
```
**Кнопки:** `Подтвердить получение` / `Подать на арбитраж`
- **Арбитраж** — как в A6 (кнопки снимаются у обеих сторон).
- **Подтвердить получение** → подтверждение необратимости → при согласии: **успешное закрытие**, перевод RC клиенту, «Сделка завершена. Оцените качество» + оценка.

---

## 6) Сторона продавца: куда получают сделки
Настраивается в @RelloClubBot → «Мой офис»: `Личные сообщения` или `Рабочая группа`.
- Если `ЛС` — карточки сделок приходят продавцу в ЛС.
- Если `Рабочая группа` — карточки в группу, где доступны продавцу и его работникам с правами.

---

## 7) Активные сделки `/active`
- Если нет — **Новое сообщение**: «Открытых сделок нет»
- Если есть — список (тип, валюта, сумма, сторона), кнопки пагинации. Выбор → открыть карточку сделки (в актуальном состоянии) с действующими кнопками.

---

## 8) История сделок `/history`
**Текст**
```
Вы можете выгрузить историю в .CSV за выбранный период от текущего дня.
Или введите команду вручную:
/stats_<дд.мм.гг>_<дд.мм.гг>
```
**Кнопки:** `Назад` / `Неделя` / `Месяц` / `Полгода` / `Год`  
Нажатие → формируем CSV и отправляем файл `deal_history_<from>_<to>.csv`.  
**Режим вывода:** Новое сообщение (с файлом)

### 8.1. Ручная команда `/stats_<дд.мм.гг>_<дд.мм.гг>`
- Невалидный ввод → **Новое сообщение** с подсказкой формата.
- Период ≤ 365 дней. Успех → отправить файл `Deal<from>-<to>.csv`.

---

## 9) Сообщения/файлы по сделке — общие правила
- Лимит файла: до `{file_max_mb}` МБ. Неверный тип → «Принимаются файлы только в форматах .PDF, .JPG, .PNG». Превышение размера → «Файл превышает {file_max_mb} МБ».
- После запуска ввода сообщения/файла допускается отмена (`Отменить`) → «Отправка сообщения отменена».
- Успешная отправка → «Сообщение отправлено», уведомить вторую сторону (и в @RelloNoticeBot).

---

## 10) Арбитраж администратором
Создаётся заявка, после чего действия у сторон **недоступны** — кнопки снимаются/сообщение помечается.

**Решения арбитра:**
- **Поровну** — размораживаем и распределяем RC 50/50; обеим сторонам сообщение «Сделка закрыта арбитром. Начислена половина средств.»
- **Полный возврат клиенту** — «Средства возвращены клиенту.»
- **Успешно** — «Сделка успешно завершена.» (админ закрывает, средства переводятся победителю по сценарию).
Все исходы дублируются в @RelloNoticeBot.

---

## 11) Технические заметки
- Таймаут ожидания ответа продавца на заявку: `{expires_min}` минут (по умолчанию 60). Истёк → автоматическая отмена (сообщение сторонам).
- При подтверждениях «без чека» фиксировать флаг в сделке; в случае арбитража — это учитывается модератором.
- Идемпотентность: проверять `version`/`state` в `callback_data`, отбрасывать повторные клики.
- Все суммы в RC — целые; курс: 1 RC = 1 USDT (для перевода валюты в RC).
- Интеграции: @RelloTopicsBot (источник объявлений), @RelloClubBot (настройки/направление), @RelloGroupBot (работа в группе), @RelloNoticeBot (уведомления), финансовое ядро (заморозка/начисления).

