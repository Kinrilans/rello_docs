# @RelloAdminBot — Панель модератора (полный флоу)

> Полная спецификация административной панели для модераторов и администраторов, обрабатывающих заявки. Стиль, структура и правила полностью согласованы с документом главного админа. Для каждого экрана указан **Режим вывода**: *Новое сообщение* / *Редактирование* / *Системное уведомление*.

---

## 0) Общие положения

### Назначение
Панель для администраторов/модераторов: модерация объявлений, арбитраж сделок, операции с Rello‑коинами (кошелёк RC), операции с депозитом, управление взятыми в работу заявками, смена языка.

### Контроль доступа и права
- При каждом входе/нажатии на раздел сверяются **права** пользователя.
- Если прав на раздел нет — показываем **Системное уведомление**:
```
У вас нет доступа к обработке этих заявок
```
- Права: **Модерация**, **Арбитраж**, **Кошелёк RC**, **Депозит**.

### Типы интерфейсов
- **Сообщение** — обычный текст (может редактироваться).
- **Системное уведомление** — `answerCallbackQuery` без нового сообщения.
- **Ожидаемый ввод** — бот ожидает ввод текста. Если не требуется — «—».

### Политика вывода сообщений (дефолт)
- Команды верхнего уровня (`/start`, `/menu`, `/info`) → **Новое сообщение**.
- Навигация по кнопкам внутри разделов → **Редактирование** текущего сообщения.
- Триггеры/переключатели/подтверждения → **Системное уведомление** (кроме случаев, когда нужен новый экран).
- Результаты с файлами/ссылками (например, выписка чата сделки) → **Новое сообщение** с файлом.
- Формы с вводом и их валидации → **Редактирование** той же формы.

### Правило актуальности сообщений и кнопок
- **После УСПЕШНОГО ввода/подтверждения** (валидный ввод, «Да, подтвердить», завершение операции) бот **удаляет предыдущее сообщение** с кнопками (`deleteMessage`) и **присылает новое** с актуальным состоянием.
- Если удаление **невозможно/нежелательно**, бот **снимает клавиатуру** (редактирование) и на дальнейшие нажатия по старому экрану отвечает: «Уже не актуально» (`answerCallbackQuery`).
- Ошибки валидации («ввод некорректен») — **без удаления** (ждём новый ввод). Удаляем/очищаем **только** после успеха.
- Рекомендация: в `callback_data` хранить **версию/токен состояния**; если не совпало — ответ «Уже не актуально».

### Динамические переменные
**Общие/профиль:**
- `{admin_nickname}` — ник администратора (напр. `@nikname`)
- `{admin_id}` — Telegram ID
- `{current_language}` — «Русский» | «English»

**Счётчики/дашборд:**
- `{in_progress_count}` — заявок у админа в работе
- `{mads_total}` — активных на модерации
- `{mdeal_total}` — активных в арбитраже
- `{mbail_in_total}` / `{mbail_out_total}` — депозит: пополнение/вывод
- `{mrc_in_total}` / `{mrc_out_total}` — кошелёк RC: пополнение/вывод

**Модерация объявлений:**
- `{ad_id}` / `{ad_title}` / `{ad_description}`
- `{ad_commission_b2c_percent}` / `{ad_commission_c2b_percent}`
- `{ad_allowed_clients}` — «Все» | «Только с депозитом»
- `{ad_deal_types}` — «Одиночные» | «Чат‑группы» | «Все»
- `{ad_currencies}` — напр. `EUR, USD`
- `{ad_client_nickname}` — владелец объявления
- `{reject_reason}` — введённая причина отказа

**Арбитраж сделки:**
- `{deal_id}` — номер сделки
- `{deal_status_text}` — описание текущего этапа (например, «Ожидание оплаты продавцом»)
- `{deal_type}` — `B2C` | `C2B`
- `{deal_amount_rc}` — сумма сделки в RC
- `{buyer_nickname}` / `{seller_nickname}`
- `{chat_export_filename}` — имя .doc с выпиской переписки

**Кошелёк RC — пополнение/вывод:**
- `{rc_request_id}` — номер заявки
- `{rc_amount}` — запрошено RC
- `{rc_fee}` — комиссия RC
- `{rc_amount_payable_usdtx}` — к оплате USDT/USDC
- `{client_nickname}` — клиент
- `{trc20_address}` — адрес TRC20 (кошелёк клиента или служебный)
- `{blockchain_tx_link}` — ссылка на транзакцию
- `{payment_timeout_hours}` — таймаут ожидания оплаты (по умолчанию `24`)

**Депозит — пополнение/вывод:**
- `{bail_request_id}` — номер заявки
- `{bail_amount_usdt}` — сумма депозита
- `{bail_fee_usdt}` — комиссия в USDT
- `{bail_amount_payable_usdt}` — к оплате (пополнение)
- `{bail_amount_to_send_usdt}` — к отправке (вывод)
- `{bail_address}` — адрес TRC20 клиента
- `{bail_tx_link}` — ссылка на транзакцию

---

## 1) Вход и регистрация `/start`

### 1.1. Пользователь найден
**Текст**
```
С возвращением, администратор {admin_nickname}
```
**Кнопки:** —  
**Ожидаемый ввод:** —  
**Режим вывода:** Новое сообщение → затем автоматически показываем меню

### 1.2. Пользователь не найден (регистрация)
**Текст**
```
Укажите токен регистрации администратора
```
**Кнопки:** —  
**Ожидаемый ввод:** Токен  
**Режим вывода:** Новое сообщение

**Проверка токена**
- Не найден/некорректен — **Новое сообщение**:
```
Ваш токен не действителен, обратитесь к главному администратору.
```
- Найден — **Новое сообщение**:
```
Добро пожаловать на ваше рабочее место, {admin_nickname}!

В зависимости от прав вы можете:
/menu — посмотреть заявки в работу
/mads — модерация объявлений
/mdeal — арбитраж сделок
/mbail — заявки по депозиту
/mrc — работа с заявками на Rello‑коины
/mjob — взятые вами в работу заявки
/info — информация о возможностях бота
```
После сообщения показываем **Меню**.

---

## 2) Меню `/menu`
**Текст**
```
Чем займётесь сегодня?

Активные запросы:
У вас в работе: {in_progress_count}
Модерация: {mads_total}
Арбитраж: {mdeal_total}
Депозит: {mbail_in_total} пополнение / {mbail_out_total} вывод
Кошелёк: {mrc_in_total} пополнение / {mrc_out_total} вывод
```
**Кнопки:** `Взятые в работу` / `Модерация` / `Арбитраж` / `Депозит` / `Кошелёк` / `Инфо`  
**Ожидаемый ввод:** —  
**Режим вывода:** Новое сообщение (по команде), далее навигация — Редактирование

---

## 3) Инфо `/info`
**Текст**
```
Доступные разделы (в зав. от прав):
/menu — посмотреть заявки в работу
/mads — модерация объявлений
/mdeal — арбитраж сделок
/mbail — заявки по депозиту
/mrc — работа с заявками на Rello‑коины
/mjob — взятые вами в работу заявки
/info — информация о возможностях бота
```
**Кнопки:** —  
**Ожидаемый ввод:** —  
**Режим вывода:** Новое сообщение

---

## 4) Модерация объявлений `/mads`
**Текст**
```
Модерация объявлений

Активные запросы: {mads_total}
Берите в работу первое в списке (сортировка по дате запроса).
```
**Кнопки:** `Назад` / `Обновить` / *(Список объявлений, пагинация по 8; текст на кнопках — названия объявлений)*  
**Ожидаемый ввод:** —  
**Режим вывода:** Редактирование

### 4.1. Обновить список
**Системное уведомление:**
```
Список обновлён
```
**Режим вывода:** Системное уведомление

### 4.2. Выбор объявления
- Если уже взял другой админ — **Системное уведомление** «Другой админ уже начал работу по данному объявлению».
- Если свободно — фиксируем ответственного, показываем карточку:

**Текст**
```
Проверьте объявление:
Название: {ad_title}
Описание: {ad_description}
Комиссии: B2C {ad_commission_b2c_percent}% | C2B {ad_commission_c2b_percent}%
Для клиентов: {ad_allowed_clients}
Тип сделок: {ad_deal_types}
Валюты сделок: {ad_currencies}

Клиент: {ad_client_nickname}
```
**Кнопки:** `Одобрить` / `Отказать`  
**Режим вывода:** Редактирование

#### 4.2.1. Одобрить
**Текст**
```
Заявка обработана:
Объявление клиента {ad_client_nickname} опубликовано
```
**Кнопки:** —  
**Режим вывода:** Редактирование  
**Уведомления:** тех‑лог и клиенту в @RelloNoticeBot

#### 4.2.2. Отказать
**Текст**
```
Введите причину отказа
```
**Кнопки:** `Назад`  
**Ожидаемый ввод:** Текст  
**Режим вывода:** Редактирование

После ввода — **удаляем** старое сообщение и шлём новое **подтверждение**:

**Текст**
```
Отказать в модерации объявления «{ad_title}» по причине: {reject_reason}?
```
**Кнопки:** `Назад` / `Да, отказать`  
**Режим вывода:** Удаление + Новое сообщение

Кнопка **«Да, отказать»** →
```
Заявка обработана:
Объявление клиента {ad_client_nickname} не опубликовано, причина: {reject_reason}
```
**Режим вывода:** Редактирование  
**Уведомления:** тех‑лог и клиенту в @RelloNoticeBot

---

## 5) Арбитраж сделок `/mdeal`
**Текст**
```
Арбитраж сделок

Активные запросы: {mdeal_total}
Берите в работу первую заявку (сортировка по дате).
```
**Кнопки:** `Назад` / `Обновить` / *(Список сделок, пагинация по 10; текст на кнопках — номер сделки или краткое название)*  
**Режим вывода:** Редактирование

### 5.1. Обновить
**Системное уведомление:** «Список обновлён»

### 5.2. Выбор сделки
- Если уже взял другой админ — **Системное уведомление** «Другой админ уже начал работу по данной сделке».
- Если свободно — фиксируем ответственного, показываем карточку:

**Текст**
```
Проверьте сделку: #{deal_id}
Статус: {deal_status_text}
Клиент: {buyer_nickname} | Продавец: {seller_nickname}
Тип сделки: {deal_type}
Сумма: {deal_amount_rc} RC

Сформируйте и посмотрите файл с перепиской по сделке.
Свяжитесь с участниками при необходимости.
Если виноваты оба — можно разделить сумму поровну.
Сложный кейс — эскалация главному администратору.
```
**Кнопки:** `Выписка сообщений` / `Отменить сделку` / `Одобрить сделку` / `Разделить поровну`  
**Режим вывода:** Редактирование

#### 5.2.1. Выписка сообщений
Формируем .doc и отправляем файл `{chat_export_filename}`.  
**Режим вывода:** Новое сообщение (с файлом)

#### 5.2.2. Отменить сделку
**Текст**
```
При отмене сделки средства будут возвращены соответствующей стороне. Подтвердить?
```
**Кнопки:** `Назад` / `Да, подтвердить`  
**Режим вывода:** Редактирование

`Да, подтвердить` →
```
Сделка #{deal_id}
Статус: {deal_status_text}
Клиент: {buyer_nickname} | Продавец: {seller_nickname}
Тип: {deal_type}
Сумма: {deal_amount_rc} RC

Была отменена арбитром.
```
**Режим вывода:** Редактирование  
**Уведомления:** клиентам через @RelloNoticeBot

#### 5.2.3. Одобрить сделку
Аналогично: подтверждение → результат «Была одобрена и завершена арбитром».  
**Режим вывода:** Редактирование  
**Уведомления:** @RelloNoticeBot

#### 5.2.4. Разделить поровну
Подтверждение → результат «Средства разделены поровну».  
**Режим вывода:** Редактирование  
**Уведомления:** @RelloNoticeBot

---

## 6) Кошелёк RC (Rello‑коины) `/mrc`
**Текст**
```
Кошелёк

Активные запросы: Пополнение — {mrc_in_total} / Снятие — {mrc_out_total}
Берите первую в списке (сортировка по дате запроса).
```
**Кнопки:** `Назад` / `Обновить` / `Пополнение` / `Снятие`  
**Режим вывода:** Редактирование

### 6.1. Пополнение
**Кнопки:** `Назад` / `Обновить` / *(Список заявок, пагинация по 10)*  
**Режим вывода:** Редактирование

- **Обновить** → «Список обновлён» *(Системное уведомление)*
- Выбор заявки:
  - Если занят — «Другой админ уже начал работу по данной заявке» *(Системное уведомление)*
  - Если свободно — фиксируем ответственного, карточка:

**Текст**
```
Пополнение средств
Заявка #{rc_request_id}
Дата открытия: {opened_at}
Сумма: {rc_amount} RC
Комиссия: {rc_fee} RC
Клиент: {client_nickname}
```
**Кнопки:** `Назад` / `Выдать кошелёк`  
**Режим вывода:** Редактирование

#### 6.1.1. Выдать кошелёк (TRC20)
**Текст**
```
Укажите рабочий крипто‑адрес TRC20, на который клиент отправит оплату.
К оплате: {rc_amount_payable_usdtx} USDT/USDC
```
**Кнопки:** `Назад`  
**Ожидаемый ввод:** Адрес TRC20  
**Режим вывода:** Редактирование

- Неверный адрес — **Новое сообщение**:
```
Кошелёк указан неверно. Указывайте рабочие крипто‑адреса, выданные главным администратором.
```
- Валидный адрес → **Удаление + Новое сообщение (подтверждение)**:
```
Пополнение средств — заявка #{rc_request_id}
К оплате: {rc_amount_payable_usdtx} USDT/USDC
Клиент: {client_nickname}
Кошелёк: {trc20_address}

Подтвердить и отправить кошелёк клиенту?
```
**Кнопки:** `Назад` / `Да, отправить`

`Да, отправить` → статус ожидания клиента, без кнопок:
```
Ожидаем подтверждения оплаты клиентом. Если в течение {payment_timeout_hours} часов нет подтверждения — отмените заявку.
```
Отправляем клиенту уведомление с кошельком.

Клиент подтвердил оплату → **Новое сообщение**:
```
Клиент оплатил средства. Проверьте поступления на кошельке.
При необходимости сделайте AML‑проверку. Если риск высокий — верните средства и отмените заявку с комментарием.
Если всё хорошо — подтвердите, и клиенту будут начислены Rello‑коины.
```
**Кнопки:** `Подтвердить` / `Отменить`  
**Режим вывода:** Редактирование

- `Подтвердить` →
```
Заявка #{rc_request_id} обработана: клиенту {client_nickname} начислено {rc_amount} RC
```
**Режим вывода:** Редактирование  
- `Отменить` → запрос причины → подтверждение → «Заявка #{rc_request_id} отменена по причине: {reject_reason}».  
**Режим вывода:** Удаление + Новое сообщение (на подтверждении)

### 6.2. Снятие (вывод RC)
**Кнопки:** `Назад` / `Обновить` / *(Список заявок, пагинация по 10)*  
**Режим вывода:** Редактирование

- Выбор заявки (с проверкой занятости) → карточка:
```
Вывод средств
Заявка #{rc_request_id}
Дата открытия: {opened_at}
Сумма: {rc_amount} RC
Комиссия: {rc_fee} RC
К отправке: {rc_amount_payable_usdtx} USDT/USDC
Адрес клиента: {trc20_address}
Клиент: {client_nickname}
```
**Кнопки:** `Назад` / `Подтвердить оплату`  
**Режим вывода:** Редактирование

`Подтвердить оплату` → запрос ссылки на блокчейн:
```
Пришлите ссылку на блокчейн‑транзакцию
```
**Ожидаемый ввод:** URL  
После ввода — **Удаление + Новое сообщение (подтверждение завершения)**:
```
Завершить заявку?
Ссылка на транзакцию: {blockchain_tx_link}
```
**Кнопки:** `Назад` / `Да, завершить`  
`Да, завершить` →
```
Заявка обработана: клиенту {client_nickname} отправлены средства
{blockchain_tx_link}
```
**Режим вывода:** Редактирование  
**Уведомления:** клиенту в @RelloNoticeBot

---

## 7) Депозит `/mbail`
**Текст**
```
Депозит

Активные запросы: Пополнение — {mbail_in_total} / Снятие — {mbail_out_total}
Берите первую в списке (сортировка по дате).
```
**Кнопки:** `Назад` / `Пополнение` / `Снятие`  
**Режим вывода:** Редактирование

### 7.1. Пополнение депозита
**Кнопки:** `Назад` / `Обновить` / *(Список заявок, пагинация по 10)*  
- Выбор заявки (с проверкой занятости) → карточка:
```
Пополнение депозита
Заявка #{bail_request_id}
Дата открытия: {opened_at}
Сумма: {bail_amount_usdt} USDT
Комиссия: {bail_fee_usdt} USDT
К оплате: {bail_amount_payable_usdt} USDT
Клиент: {client_nickname}
```
**Кнопки:** `Назад` / `Выдать кошелёк`  
**Режим вывода:** Редактирование

`Выдать кошелёк` → запрос TRC20‑адреса; валидация (ошибка — **Новое сообщение**). Валидно → **Удаление + Новое сообщение (инструкция)**:
```
Напишите условия/инструкцию по переводу депозита.
```
**Ожидаемый ввод:** Текст инструкции  
Ввод → **Редактирование** (подтверждение отправки кошелька клиенту) → `Да, отправить` → статус ожидания клиента *(без кнопок)*:
```
Ожидаем подтверждения оплаты клиентом. Если в течение {payment_timeout_hours} часов нет подтверждения — отмените заявку.
```
Клиент подтвердил → карточка с ссылкой на блокчейн `{bail_tx_link}` и кнопки `Подтвердить` / `Отменить`.
- `Подтвердить` → «Заявка #{bail_request_id} обработана: депозит клиента {client_nickname} пополнен на {bail_amount_usdt} USDT» *(Редактирование)*.
- `Отменить` → запрос причины → подтверждение → «Заявка #{bail_request_id} отменена по причине: {reject_reason}» *(Удаление + Новое сообщение)*.

### 7.2. Снятие депозита (вывод)
Выбор заявки (с проверкой занятости) → карточка:
```
Вывод депозита
Заявка #{bail_request_id}
Дата открытия: {opened_at}
Сумма: {bail_amount_usdt} USDT
Комиссия: {bail_fee_usdt} USDT
К отправке: {bail_amount_to_send_usdt} USDT
Адрес клиента: {bail_address}
Клиент: {client_nickname}
```
**Кнопки:** `Назад` / `Подтвердить оплату`  
**Режим вывода:** Редактирование

`Подтвердить оплату` → запрос ссылки на блокчейн → **Удаление + Новое сообщение (подтверждение завершения)** → `Да, завершить` →
```
Заявка обработана: клиенту {client_nickname} отправлены средства
{bail_tx_link}
```
**Уведомления:** клиенту в @RelloNoticeBot

---

## 8) Взятые в работу заявки `/mjob`
**Текст**
```
Взятые в работу заявки

Активные с вашим участием:
Модерация: …
Арбитраж: …
Кошелёк: Пополнение — … / Снятие — …
Депозит: Пополнение — … / Снятие — …
```
**Кнопки:** `Назад` / `Модерация` / `Арбитраж` / `Кошелёк` / `Депозит`  
**Режим вывода:** Редактирование

Каждая подкатегория → список (пагинация по 10) → карточка выбранной заявки (как в соответствующем разделе). Все правила занятости/подтверждений/удаления старых сообщений — те же.

---

## 9) Сменить язык сервиса `/lang`
**Текст**
```
Выберите язык сервиса
Установлено — {current_language}
```
**Кнопки:** `Назад` / `Русский` / `English`  
**Режим вывода:** Редактирование

Выбор языка:
- Если выбран уже установленный — **Системное уведомление** «Данный язык уже установлен».
- Иначе меняем язык для всех ботов и шлём **Системное уведомление** «Язык успешно изменён».

---

## 10) Спецкоманды главного администратора (в этом боте)
Доступны **только** владельцу сервиса (ID из конфига). Остальным — сообщение об отсутствии доступа.

- `/adads<номер>` — модерация (забрать в работу)
- `/addeal<номер>` — арбитраж
- `/adbail<номер>` — депозит
- `/adrc<номер>` — кошелёк

Проверяем автора команды; если не владелец — **Новое сообщение** «У вас нет доступа». Если владелец — открываем карточку нужной заявки на актуальном этапе, с возможностью действия как у обычного админа.

---

## 11) Сводка команд
- `/start` — вход/регистрация
- `/menu` — главное меню
- `/info` — справка
- `/mads` — модерация объявлений
- `/mdeal` — арбитраж сделок
- `/mrc` — кошелёк RC (пополнение/снятие)
- `/mbail` — депозит (пополнение/снятие)
- `/mjob` — заявki, взятые в работу
- `/lang` — смена языка
- Спецкоманды владельца: `/adads…`, `/addeal…`, `/adbail…`, `/adrc…`

---

## 12) Технические заметки
- Лок на заявку при «взятии в работу» (с указанием admin_id и времени); повторное нажатие другим — «Другой админ уже начал работу…».
- Аудит: логировать все действия (дата, admin_id, тип заявки/ID, действие, результат, trace_id).
- Сообщения после успешных действий: **удаляем экран с кнопками** → присылаем новый; fallback — снятие клавиатуры + «Уже не актуально».
- Валидации адресов TRC20/URL — строго до подтверждения; суммы/комиссии — в валюте запроса.
- Интеграция с финансовым ядром: начисление RC, поп/вывод депозита, статусы, ссылки на блокчейн; уведомления клиентам — через `@RelloNoticeBot`.

> Готово для разработки и QA. Структура и правила согласованы с админ‑панелью владельца, включены все сценарии: модерация, арбитраж, кошелёк RC, депозит, языки и «взятые в работу». 

