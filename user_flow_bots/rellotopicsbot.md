# @RelloTopicsBot — Публикация объявлений в закрытой группе (полный флоу)

> Полная спецификация бота‑администратора, публикующего объявления в закрытой группе. Стиль и структура едины с остальными документами: вынесены **переменные**, для каждого экрана/кнопки указан **Режим вывода** (*Новое сообщение / Редактирование / Системное уведомление*), действует **правило актуальности**.

---

## 0) Общие положения

### Назначение

`@RelloTopicsBot` размещает, обновляет и удаляет объявления клиентов в закрытой группе (теме). Под сообщениями объявления отображаются кнопки действий для потенциальных клиентов: *Одиночная сделка*, *Работа в чат‑группе*, *Написать пользователю*.

### Контроль доступа

- Бот добавлен в закрытую группу как **администратор** с правами на удаление/редактирование сообщений и управление темами.
- Нажимать кнопки под объявлениями может любой участник группы; дальнейшие действия доступны только **зарегистрированным** клиентам Rello и (при необходимости) клиентам с требуемым **депозитом**.

### Типы интерфейсов

- **Пост объявления** — сообщение в группе с текстом и инлайн‑кнопками.
- **Системное уведомление** — `answerCallbackQuery` на нажатие кнопки (отображается только нажатому пользователю, не засоряет группу).
- **Ожидаемый ввод** — в рамках данного бота отсутствует (ввод происходит в других ботах).

### Политика вывода сообщений (дефолт)

- Публикация/обновление объявления → **Новое сообщение** или **Редактирование** существующего поста (в зависимости от сценария публикации/поднятия).
- Нажатия на инлайн‑кнопки под объявлением → **Системные уведомления** (короткие ответы) + передача данных в соответствующие боты/сервисы.
- Журнальные/технические сообщения в группу **не публикуются** (избегаем спама).

### Правило актуальности сообщений и кнопок

- После **деактивации**/удаления объявления бот **удаляет** пост или **снимает** клавиатуру у старого поста. На дальнейшие нажатия старых кнопок отвечает: «Уже не актуально» (через `answerCallbackQuery`).
- При обновлении содержимого (редактирование, «поднять») — старый пост **удаляется** и создаётся **новый** (если включён «перепост»), либо выполняется **Редактирование** с обновлением текста и клавиатуры.

### Переменные (для шаблона поста)

- `{owner_nickname}` — владелец объявления (например, `@Moolleer`)
- `{owner_rating}` — рейтинг владельца (напр. `4.98`)
- `{owner_deposit_tier}` — «S / A / B / C / D» (если применимо)
- `{owner_capacity}` — краткая ёмкость/лимиты, например «1kk USDT» (опционально)
- `{ad_title}` — название
- `{ad_description}` — описание
- `{ad_b2c_percent}` / `{ad_c2b_percent}` — комиссии, %
- `{deal_range_min_rc}` — минимум RC для сделки
- `{deal_range_max_rc}` — максимум RC (или «Неограниченно»)
- `{ad_allowed_clients}` — «Всех» | «Только с депозитом от {tier} и выше»
- `{ad_currencies_hashtags}` — валюты через хэштеги (`#EUR, #USD, …`)
- `{ad_id}` — ID объявления (служебно)
- `{post_id}` — ID поста в группе (служебно)

---

## 1) Шаблон публикации объявления (пост в группе)

**Текст поста**

```
{owner_nickname} {owner_rating} {owner_deposit_tier} {owner_capacity}

{ad_title}
{ad_description}
Комиссии: B2C {ad_b2c_percent}% | C2B {ad_c2b_percent}%
Диапазон сделок: {deal_range_min_rc} RC - {deal_range_max_rc} RC
Для клиентов: {ad_allowed_clients}
Валюты сделок: {ad_currencies_hashtags}
```

**Кнопки:** `Одиночная сделка` / `Работа в чат группе` / `Написать пользователю`\
**Ожидаемый ввод:** —\
**Режим вывода:** Новое сообщение *(публикация)* / Редактирование *(обновление)*

> Примечание: в шапке допускается краткая строка формата: `Moolleer 4.98 S 1kk USDT`.

---

## 2) Кнопка «Одиночная сделка»

**Проверки:**

1. **Регистрация в Rello**. Если пользователь не зарегистрирован:

```
Вы не зарегистрированы
```

**Режим вывода:** Системное уведомление

2. **Требуемый депозит**. Если объявление доступно только для клиентов с депозитом и у пользователя тира/суммы недостаточно:

```
Для работы с данным партнером нужно иметь минимум ____ USDT депозита
```

**Режим вывода:** Системное уведомление

3. **Минимальный порог сделки**. Если баланса RC меньше минимума в диапазоне сделки:

```
У вас недостаточно средств для открытия минимальной сделки
```

**Режим вывода:** Системное уведомление

**Успех (все проверки пройдены):**\
Определяем направление, заданное владельцем объявления в @RelloClubBot: `Личные сообщения` или `Рабочая группа`.

- **В ЛС** — инициируем сделку через @RelloDealBot с продавцом (владельцем объявления).
- **В рабочую группу** — инициируем сделку через @RelloDealBot в рабочей группе владельца.\
  Дальнейшее флоу — в боте @RelloDealBot.\
  **Режим вывода:** Системное уведомление *(успешный триггер, без новых сообщений в группе)*

---

## 3) Кнопка «Работа в чат группе»

**Проверки:**

1. Регистрация:

```
Вы не зарегистрированы
```

**Режим вывода:** Системное уведомление

2. Требуемый депозит:

```
Для работы с данным партнером нужно иметь минимум ____ USDT депозита
```

**Режим вывода:** Системное уведомление

**Успех:**\
Передаём данные в @RelloClubBot и открываем флоу «Работа в чат‑группах» (создание/подключение группы, токены и т.п.).\
**Режим вывода:** Системное уведомление *(успешный триггер)*

---

## 4) Кнопка «Написать пользователю»

**Проверки:**

1. Регистрация:

```
Вы не зарегистрированы
```

**Режим вывода:** Системное уведомление

**Успех:**\
Передаём данные в @RelloClubBot → раздел «Написать пользователю» (диалог в личном кабинете клиента).\
**Режим вывода:** Системное уведомление *(успешный триггер)*

---

## 5) Операции с постами (служебные сценарии)

- **Публикация**: создаём новый пост по шаблону → сохраняем `{post_id}`.\
  **Режим вывода:** Новое сообщение (в группе)
- **Обновление**: либо *Редактирование* существующего поста, либо *Удаление + Новое сообщение* (режим «перепоста», в т.ч. при «поднятии» объявления).\
  **Режим вывода:** Редактирование / Удаление + Новое сообщение
- **Удаление**: удаляем пост из группы, например при деактивации/удалении объявления.\
  **Режим вывода:** — (только действие в группе)
- **Деактивация**: снимаем инлайн‑клавиатуру у поста, дальнейшие нажатия → «Уже не актуально».\
  **Режим вывода:** Редактирование (снятие клавиатуры); ответы — Системные уведомления

---

## 6) Технические заметки

- Все проверки (регистрация, депозит, доступный RC) выполняются до старта сторонних флоу; сообщения об ошибках выдаются **только** как `answerCallbackQuery` (не засоряя группу).
- Передача данных: внутри‑сервисные вызовы с контекстом `{ad_id}`, `{owner_nickname}`, параметрами сделки и пользователем, нажавшим кнопку.
- «Диапазон сделок» отображаем в RC; для сравнения доступности используем баланс пользователя в RC (с учётом заморозок).
- При «поднятии» объявления внешним действием (из @RelloClubBot) допускается удаление старого поста и публикация нового — это обновит хронологию темы.
- Логи модерации/публикации пишутся в тех‑журнал (без сообщений в группу).

