# @RelloNoticeBot — Нотификатор (полный флоу)

> Бот уведомлений для клиентов и их работников. Принимает события из остальных ботов и финансового ядра и отправляет пользователям **новые сообщения** с итогами операций, статусами заявок и сделок. Структура и стиль едины с остальными документами: вынесены **переменные**, указаны **Режимы вывода**, действует **правило актуальности**.

---

## 0) Общие положения

### Назначение

`@RelloNoticeBot` — единая точка доставки уведомлений: пополнения/выводы RC и депозита, модерация объявлений, события сделок (B2C/C2B), арбитраж, регистрация работников, блокировки.

### Контроль доступа

- Получателем уведомления может быть только **участник Rello** или зарегистрированный **работник**.
- Тип уведомлений зависит от роли и контекста (клиент/продавец/работник). Работники получают только релевантные рабочие события.

### Типы интерфейсов

- **Сообщение** — текст в личных сообщениях с пользователем. Кнопки используются редко, только там, где нужны дальнейшие действия (например, «Ответить», «Открыть ссылку»).
- **Системное уведомление** — краткий ответ `answerCallbackQuery` (используется минимально).

### Политика вывода сообщений (дефолт)

- Все уведомления отправляются как **Новое сообщение** (не редактируются, не удаляются), чтобы фиксировать историю.
- Для предотвращения дублей источники передают **идемпотентный ключ** (`notice_id`); при повторной доставке сообщение не отправляется повторно.

### Правило актуальности

- Поскольку нотификации **не требуют ввода**, правило удаления старых экранов **не применяется**.&#x20;

### Переменные

- Общие: `{recipient}` (ник получателя), `{role}` (`клиент`/`продавец`/`работник`), `{opened_at}` (дата/время), `{admin_comment}`.
- Заявки: `{request_id}`, `{status}`.
- Сделки: `{deal_id}`, `{deal_type}` (`B2C`/`C2B`), `{group_link}`, `{seller}`, `{client}`.
- Суммы/валюты: `{fiat_currency}`, `{fiat_amount}`, `{rc_amount}`, `{fee_seller_rc}`, `{fee_service_rc}`, `{balance_rc}`.
- Сети/AML: `{blockchain_tx_link}`, `{aml_result}`.

---

## 1) Запуск `/start`

### 1.1. Пользователь не найден

**Текст**

```
Вы не являетесь членом клуба
```

**Режим вывода:** Новое сообщение

### 1.2. Успешный запуск

**Текст**

```
Добро пожаловать в центр уведомлений Rello Notice. Сюда будут приходить уведомления по сделкам и другие важные уведомления.

Приятной работы.
```

\
**Режим вывода:** Новое сообщение

---

## 2) Уведомления от @RelloClubBot (кошелёк RC, депозит, объявления, рефералка)

### 2.1. Покупка/Вывод Rello‑коинов (RC)

#### 2.1.1. Покупка RC — AML высокий риск (возврат)

**Текст**

```
Пополнение средств
Заявка #{request_id}
Дата открытия: {opened_at}
Сумма: {rc_amount} RC
Комиссия: {fee_service_rc} RC

Ваши средства были выявлены AML‑проверкой как имеющие высокий риск, средства отправлены обратно с вычетом комиссии.

Результаты проверки:
{aml_result}
```

**Режим вывода:** Новое сообщение

#### 2.1.2. Покупка RC — Успешно

**Текст**

```
Ваша заявка #{request_id}
Успешно выполнена!

Зачислено: {rc_amount} RC
Баланс: {balance_rc} RC
```

**Режим вывода:** Новое сообщение

#### 2.1.3. Покупка RC — Отмена администратором

**Текст**

```
Пополнение средств
Заявка #{request_id}
Дата открытия: {opened_at}
Сумма: {rc_amount} RC
Комиссия: {fee_service_rc} RC

Ваша заявка была отменена, причина:
{admin_comment}
```

**Режим вывода:** Новое сообщение

#### 2.1.4. Вывод RC — Выполнено

**Текст**

```
Ваша заявка #{request_id}
на вывод успешно выполнена!

Списано: {rc_amount} RC
Баланс: {balance_rc} RC

Ссылка на блокчейн: {blockchain_tx_link}
```

**Режим вывода:** Новое сообщение

### 2.2. Депозит (пополнение/вывод)

#### 2.2.1. Пополнение депозита — Отказ

**Текст**

```
Ошибка
{admin_comment}
```

**Режим вывода:** Новое сообщение

#### 2.2.2. Пополнение депозита — Выполнено

**Текст**

```
Ваш депозит успешно пополнен и составляет {fiat_amount} USDT.
```

**Режим вывода:** Новое сообщение

#### 2.2.3. Вывод депозита — Выполнено

**Текст**

```
Ваша заявка #{request_id} выполнена, ожидайте. Ваш депозит отправлен.
Ссылка на блокчейн: {blockchain_tx_link}
```

**Режим вывода:** Новое сообщение

#### 2.2.4. Вывод депозита — Отказ

**Текст**

```
Ваша заявка #{request_id} отклонена. Причина: {admin_comment}
```

**Режим вывода:** Новое сообщение

### 2.3. Модерация объявлений

#### 2.3.1. Создание — Одобрено

**Текст**

```
Ваше объявление:
«{ad_title}»

Одобрено модератором и опубликовано в группе: {ad_link}
```

**Режим вывода:** Новое сообщение

#### 2.3.2. Создание — Отказ

**Текст**

```
Ваше объявление:
«{ad_title}»

Не прошло модерацию, комментарий модератора: {admin_comment}
```

**Режим вывода:** Новое сообщение

#### 2.3.3. Обновление — Одобрено

**Текст**

```
Ваше объявление:
«{ad_title}»

Обновление одобрено и опубликовано: {ad_link}
```

**Режим вывода:** Новое сообщение

#### 2.3.4. Обновление — Отказ

**Текст**

```
Ваше объявление:
«{ad_title}»

Не прошло модерацию, комментарий модератора: {admin_comment}
```

**Режим вывода:** Новое сообщение

### 2.4. Работа в чат‑группах (заявки)

#### 2.4.1. Отказ

**Текст**

```
Заявка на рабочую группу:
Продавец: {seller}

Отказано, причина:
{admin_comment}
```

**Режим вывода:** Новое сообщение

#### 2.4.2. Принято/Выполнено

**Текст**

```
Заявка на рабочую группу:
Продавец: {seller}

Ожидайте, продавец добавит вас в рабочую группу и запустит бота менеджера.
После этого можно проводить сделки за Rello‑коины и выводить в USDT/USDC.
```

**Режим вывода:** Новое сообщение

### 2.5. Реферальная программа

#### 2.5.1. Зарегистрирован новый клиент по вашему токену

**Текст**

```
По вашему реферальному токену зарегистрирован новый клиент {client}. Поделитесь с ним информацией, как работать в нашем клубе.
Теперь вы будете получать % с каждой сделки своего реферала.
```

**Режим вывода:** Новое сообщение

#### 2.5.2. Ежемесячная выплата

**Текст**

```
На ваш счёт зачислены {rc_amount} RC по реферальной программе за прошлый месяц.
Спасибо, что вы с нами!
```

**Режим вывода:** Новое сообщение

#### 2.5.3. Токен истёк

**Текст**

```
Ранее выданный токен реферальной программы истёк, запросите новый.
Спасибо, что вы с нами!
```

**Режим вывода:** Новое сообщение

---

## 3) Уведомления от @RelloGroupBot (работа в чат‑группах)

### 3.1. Арбитраж завершённых сделок (оба типа)

#### 3.1.1. Решение арбитра — половина средств

**Текст**

```
Сделка #{deal_id}
Группа — {group_link}

Сделка закрыта арбитром.
Вам начислена половина средств.
В случае вопросов — @RelloSupport.
```

**Режим вывода:** Новое сообщение

#### 3.1.2. Решение арбитра — возврат клиенту

**Текст**

```
Сделка #{deal_id}
Группа — {group_link}

Сделка закрыта арбитром.
Средства возвращены клиенту.
В случае вопросов — @RelloSupport.
```

**Режим вывода:** Новое сообщение

#### 3.1.3. Успешное завершение (зачисление)

**Текст**

```
Сделка #{deal_id}
Группа — {group_link}

Сделка успешно завершена.
Средства {rc_amount} RC успешно зачислены.
```

**Режим вывода:** Новое сообщение

### 3.2. Сделки B2C / C2B — итоговые нотификации

#### 3.2.1. B2C — Клиенту

**Текст**

```
Сделка B2C завершена успешно
Номер сделки: #{deal_id}
Продавец {seller}, группа — {group_link}

Зачислено: {rc_amount} RC
Баланс: {balance_rc} RC
```

**Режим вывода:** Новое сообщение

#### 3.2.2. C2B — Клиенту

**Текст**

```
Сделка C2B завершена успешно
Номер сделки: #{deal_id}
Продавец {seller}, группа — {group_link}

Списано: {rc_amount} RC
Баланс: {balance_rc} RC
```

**Режим вывода:** Новое сообщение

#### 3.2.3. B2C — Продавцу

**Текст**

```
Сделка B2C завершена успешно
Номер сделки: #{deal_id}
Клиент {client}, группа — {group_link}

Списано: {rc_amount} RC
Баланс: {balance_rc} RC
```

**Режим вывода:** Новое сообщение

#### 3.2.4. C2B — Продавцу

**Текст**

```
Сделка C2B завершена успешно
Номер сделки: #{deal_id}
Клиент {client}, группа — {group_link}

Зачислено: {rc_amount} RC
Баланс: {balance_rc} RC
```

**Режим вывода:** Новое сообщение

#### 3.2.5–3.2.8. Запросы на сделки (B2C/C2B) — карточка‑уведомление

**Текст (пример B2C)**

```
Запрос B2C сделки

Группа: {group_link}
Клиент {client} хочет начать сделку.

Валюта и сумма: {fiat_amount} {fiat_currency}
Сумма в Rello‑коинах: {rc_amount} RC
Комиссия продавца: {fee_seller_rc} RC
Комиссия сервиса: {fee_service_rc} RC

{seller} (продавец) к получению: … RC
{client} (клиент) к оплате/получению: … RC
```

**Режим вывода:** Новое сообщение

### 3.3. Вывод RC из группы — Выполнен

**Текст**

```
Ваша заявка #{request_id}
на вывод успешно выполнена!

Списано: {rc_amount} RC
Баланс: {balance_rc} RC

Ссылка на блокчейн: {blockchain_tx_link}
```

**Режим вывода:** Новое сообщение

### 3.4. Покупка RC (повтор уведомлений, если источником была группа)

— шаблоны 2.1.1–2.1.3.

---

## 4) Уведомления от @RelloDealBot (одиночные сделки)

### 4.1. Регистрация работников

**Текст**

```
В рабочей группе «{group_title}» зарегистрировался работник, теперь он также может обрабатывать сделки.
```

**Режим вывода:** Новое сообщение

### 4.2. Сделки клиента — C2B

#### 4.2.1. Закрыта арбитром — пополам

**Текст**

```
Сделка #{deal_id}
Продавец: {seller}
Валюта и сумма: {fiat_amount} {fiat_currency}
Сумма в Rello‑коинах: {rc_amount} RC
Комиссия продавца: {fee_seller_rc} RC
Итого: … RC

Закрыта арбитром. Половина средств отправлена продавцу.
В случае вопросов — @RelloSupport.
```

**Режим вывода:** Новое сообщение

#### 4.2.2. Закрыта арбитром — возврат

**Текст** — как выше, финальная фраза: «Средства возвращены вам.»

#### 4.2.3. Отправлено на арбитраж

**Текст** — как выше, финальная фраза: «Сделка отправлена на арбитраж, ожидайте. Вам может написать администратор площадки @RelloSupport.»

#### 4.2.4. Выполнена

**Текст** — как выше, финальная фраза: «Сделка успешно завершена.»

### 4.3. Сделки продавца — B2C

#### 4.3.1. Закрыта арбитром — пополам

**Текст** — аналог 4.2.1, роли/итоги заменены для продавца.

#### 4.3.2. Закрыта арбитром — возврат

**Текст** — «Средства возвращены вам.»

#### 4.3.3. Отправлено на арбитраж

**Текст** — уведомление о передаче в арбитраж.

#### 4.3.4. Выполнена

**Текст** — «Сделка успешно завершена.»

---

## 5) Уведомления от @RelloOfficeBot (блокировки)

### 5.1. Блокировка

**Текст**

```
Вы были заблокированы в сервисе Rello. Для уточнения причин свяжитесь с администратором @RelloSupport.
```

**Режим вывода:** Новое сообщение

### 5.2. Разблокировка

**Текст**

```
Вы успешно разблокированы на сервисе.
```

**Режим вывода:** Новое сообщение

---

## 6) Технические заметки

- Все тексты формируются на стороне источника события и передаются нотификатору с параметрами (переменные выше). Допустима локализация RU/EN по профилю пользователя.
- Для ссылок используем кликабельный формат Telegram (где возможно) — например, «группа — {group\_link}».
- Дедупликация: источники обязаны отправлять `notice_id` или `request_id`/`deal_id` + `status`, нотификатор хранит журнал последних N уведомлений и не дублирует.
- SLA доставки: при недоставке — до 3 ретраев с back‑off (5/30/180 сек). Ошибки логируются.
- Контент‑фильтр: размер сообщений ≤ 4096 символов; поля, указанные как «комментарий/результат AML», обрезаются по разумной длине с маркером «…».

