# Runbooks (v1) — Операционные процедуры

Часовой пояс: **Europe/Warsaw**. Токены: **USDT/USDC**. Сети: **ERC‑20/TRC‑20**.  
Роли, упоминаемые ниже: **Ops (on‑call)**, **Treasury Admin**, **Risk Admin**, **Arbiter**, **Platform Admin**.

---

## 0) Принципы и уровни инцидентов
- **SEV1** — блокирующая деградация выплат/приёма: остановка pass‑through/EOD во всех сетях или потеря ключевых данных.
- **SEV2** — частичная деградация: одна сеть/кошелёк, рост латентности >2×, очередь выплат >X минут.
- **SEV3** — минорные сбои: вебхуки, единичные stuck‑tx, отдельные компании.

**RACI**: Ops — ответственный; Treasury — соисполнитель; Risk/Arbiter — по необходимости; Platform Admin — эскалация SEV1.

---

## 1) Приём входящих (pass‑through)
**Триггеры**: `incoming_tx.detected` или запрос трейдера `/pay_in`.

**Шаги**
1. Проверить **сеть/токен** и адрес: должен совпадать с адресом платформы для сделки.  
2. Сверить **сумму** (допуск **±0.5%**). Если отклонение больше — поставить флаг `manual_review` и уведомить стороны.  
3. Отслеживать **подтверждения** до `min_confirmations` сети.  
4. По достижении — сменить статус `txn_confirmed` и активировать **auto‑payout**.  
5. Вебхуки: `deal.auto_payout_sent` → `payout.confirmed`.

**Отклонения**
- Неверная сеть/токен → отклонить, открыть карточку инцидента, предложить переотправку/коррекцию (Arbiter при споре).  
- Сомнительный tx (старый nonce, странный memo) → на hold, уведомить Risk.

---

## 2) Исходящие stuck‑tx (ERC‑20/TRC‑20)
**Детектор**: `stuck_timeout_min` (по умолчанию 30 мин ERC‑20 / 20 мин TRC‑20) без роста подтверждений.

**Шаги (ERC‑20)**
1. Проверить мемпул/fee → поднять `fee_mode` до `priority`.  
2. Выполнить **speed‑up** (replacement tx тем же nonce с бóльшим `maxFeePerGas`).  
3. При необходимости — **cancel** (self‑tx) и повторить выплату.  
4. Обновить карточку выплаты, уведомить получателя.

**Шаги (TRC‑20)**
1. Проверить **Energy/Bandwidth**; докупить/перераспределить TRX.  
2. Повторить отправку с учётом лимитов.  
3. При множественных фейлах — переключить RPC.

**Эскалация**: >2 часов без подтверждения → SEV2; >6 часов и влияние на EOD → SEV1.

---

## 3) EOD‑ликвидность и T+1
**За 60/15/5 минут до cut‑off** по каждой активной паре:
1. Снять прогноз **net** и список `eod_settlement`.  
2. Проверить **hot‑баланс** token + газ (ETH/TRX) против потребности.  
3. Если дефицит > 10% — инициировать **ребаланс из cold** или пометить пары как **partial/T+1**.  
4. Уведомить стороны через @ClubGateBot: «Частичная оплата, остаток — T+1».

**После cut‑off**
- Закрыть `trust_session` → создать `eod_settlement` → отправить выплаты (батчи).  
- Если частично — поставить остаток в приоритетную очередь на следующий день.

**Отчёт**: CSV по сессиям, процент partial, причины (ликвидность/сеть).

---

## 4) Ребаланс hot/cold
**Триггеры**: падение ниже `min_hot_balance`; плановая подготовка к EOD.

**Шаги**
1. Создать заявку ребаланса → M‑of‑N подписи (ручное подтверждение).  
2. Отправить **тест 1 USDT**, сверить поступление.  
3. Отправить основной перевод → подождать `min_confirmations`.  
4. Обновить `hot_balance` и журналы.  
5. Включить выплаты, если были остановлены.

**Замечания**: держать **safety‑buffer** газа; при авариях — перевести выплаты на запасной hot.

---

## 5) Расхождения trust‑ledger / неттинга
**Симптом**: сторона заявляет «сумма/направление нетто неверны».

**Шаги**
1. Открыть `trust_session` и `trust_ledger` (фильтр по дате/TZ пары).  
2. Сверить сделки дня, исключить те, у которых флажок неттинга снят.  
3. При ошибке записи — добавить **adjustment** с комментарием (кто/почему).  
4. Нажать **Recompute** в @TreasuryBot `/settlements`.  
5. Если стороны не согласны — оформить **спор (trust)** в @ArbiterDeskBot.

---

## 6) Вывод депозита (T+N)
**Проверки перед approve**
- `exposure_open = 0`;
- нет активных споров/несмещённых EOD‑сессий;
- адрес в allow‑list; 2FA у инициатора.

**Шаги**
1. Подтвердить запрос (Approver) → статус `pending_T+N`.  
2. По окончании окна — отправить выплату; при инциденте сети — уведомить и перенести.  
3. Завершить `withdraw_sent/confirmed`, обновить ledger.

---

## 7) Деградация вебхуков
**Симптомы**: рост `X-Attempt`, dead‑letter растёт, жалобы интеграторов.

**Шаги**
1. Проверить DNS/RPC и latency до endpoint’ов.  
2. Увеличить таймауты/окна ретраев временно.  
3. Связаться с интеграторами (шаблон ниже), предложить **replay**.  
4. После стабилизации — запустить **bulk replay** за проблемный интервал.

---

## 8) Safe‑mode
**Сценарии**: аномалии сети, компрометация RPC/ключей, массовые stuck‑tx, недоступность хранилищ.

**Действия**
1. В админ‑консоли: включить баннер **maintenance** и **safe‑mode**: «EOD off, pass‑through only»/«freeze manual payouts»/«freeze withdraw».  
2. Остановить payout‑engine по сетям с проблемой.  
3. Перевести все новые сделки в **deposit‑mode** без авто‑выплат.  
4. Сделать рассылку в @ClubGateBot и партнёрам.

**Выход из safe‑mode**: чек‑лист ниже, по M‑of‑N.

---

## 9) Инциденты: чек‑лист и постмортем
**SEV triage**
- Определить масштаб (сети/кошельки/боты/эскалации).  
- Создать канал инцидента, назначить роли (IC, коммс, аналитик).  
- Вести таймлайн (UTC+2).

**Коммуникации**
- Внешние: короткий статус каждые 30–60 мин; итог — сводка.  
- Внутренние: каждые 15 мин обновление для руководства.

**Постмортем (шаблон)**
- Что произошло / влияние / таймлайн / корневая причина / корректирующие действия / превентивные меры / SLA‑замеры.

---

## 10) On‑call и ежедневные проверки
**Смена on‑call**: 09:00–21:00 и 21:00–09:00 (два слота).  
**Ежедневно утром**:
- здоровье RPC, баланс hot (token/газ), очередь выплат, ретраи вебхуков, dead‑letter=0, stuck‑tx=0.  
**За 1ч до массовых EOD**:
- прогноз нетто, капы сети, готовность hot/cold.

---

## 11) Шаблоны сообщений
**EOD partial/T+1 (RU)**
> Сегодня по паре {A↔B} за {DATE} будет **частичная оплата** {AMOUNT} {TOKEN} из‑за дефицита ликвидности сети. Остаток {REMAIN} будет выплачен **T+1** с приоритетом. Приносим извинения за задержку.

**Webhooks degraded (EN)**
> We’re experiencing degraded webhook delivery between {FROM}–{TO}. Your endpoint may receive retries. You can safely replay via our Console or API (`/events`).

**Safe‑mode (RU)**
> Включён **safe‑mode**: выплаты по сети {NETWORK} временно приостановлены. Pass‑through переведён в ручной режим. Следующее обновление — в {HH:MM}.

---

## 12) Критерии выхода из SEV
- SEV1 → SEV2: восстановлен pass‑through в ≥1 сети, очередь стабильно снижается.  
- SEV2 → SEV3: латентность выплат < 1.5× номинала, stuck‑tx < порога, вебхуки <1% ретраев.  
- Закрытие: все метрики в зелёной зоне ≥ 2 часов, postmortem запланирован.

---

## 13) Чек‑лист выхода из safe‑mode
1. RPC зелёные, баланс hot ≥ порога, fee‑рынок стабилен.  
2. Очереди выплат < порога; нет критичных dead‑letter вебхуков.  
3. Прогнать **тест‑выплату 1 USDT** в каждой сети.  
4. Снять баннер, включить EOD, уведомить партнёров.

---

## 14) Приложение: быстрые команды
- @TreasuryBot: `/settlements`, `/payouts`, `/pay_out`, `/deposit`, `/withdraw_deposit`.  
- @DealDeskBot: `/browse_offers`, `/deal <id>`, переключатель «Неттинг в EOD».  
- @ArbiterDeskBot: `/cases`, `/case <id>`, `/resolve`.  
- @ClubGateBot: `/trust_pairs`, `/trust_partner <id>`, `/inbox`.

---

## 15) Метрики и пороги (стартовые)
- Очередь выплат: p95 < **10 мин** (pass‑through), < **30 мин** (EOD).  
- Ретраи вебхуков: < **1%** за 15 мин окно.  
- Stuck‑tx: < **3**/день/сеть.  
- Partial/T+1: < **5%** объёма EOD.  
- Успешные EOD‑расчёты: > **95%** сессий/день.

