# Backup/Restore (v1) — политика бэкапов и восстановление

Часовой пояс: **Europe/Warsaw**. Область: все компоненты закрытой платформы (боты, API, БД, файлы, конфиги, метрики/логи). Цель — обеспечить восстановление сервиса при инцидентах с заданными **RPO/RTO** и доказуемую целостность данных.

---

## 0) Термины и цели
- **RPO** (Recovery Point Objective): максимум потерянных данных при восстановлении.  
- **RTO** (Recovery Time Objective): максимум допустимого времени простоя до полного восстановления.
- Принцип **3‑2‑1**: 3 копии, 2 разных медиа, 1 — вне площадки.  
- **Immutability/WORM** для критичных бэкапов (защита от удаления/шифровальщиков).

---

## 1) Инвентарь данных
1. **Core DB (PostgreSQL)** — сделки, офферы, лимиты, trust‑ledger, eod_settlement, webhooks, audit.  
2. **Evidence/файлы** — материалы споров, выписки, скрины (объектное хранилище).  
3. **Конфиги/секреты** — config_snapshot, ключи вебхуков, JWKS (публичные), параметры сетей/кошельков.  
4. **Логи/метрики/трейсы** — Loki/ELK, Prometheus, OTLP.  
5. **Артефакты ботов** — словари текстов, шаблоны сообщений, deeplink tickets (краткоживущие).  
6. **Подписант/кошельки** — *приватные ключи не резервируются в явном виде в обычные бэкапы*; резерв делается через **HSM/мультисейф** (см. SOP кошельков).

---

## 2) Целевые RPO/RTO
| Компонент | Критичность | RPO | RTO |
|---|---|---|---|
| **PostgreSQL (Core)** | P0 | ≤ **5 мин** (WAL‑стрим) | ≤ **60 мин** |
| **Evidence/файлы (S3‑совмест.)** | P1 | ≤ **15 мин** (версионирование) | ≤ **120 мин** |
| **Конфиги/секреты** | P0 | ≤ **5 мин** | ≤ **60 мин** |
| **Метрики/логи** | P2 | ≤ **60 мин** | ≤ **240 мин** |
| **JWKS/ключи подписи** | P0 | RPO 0 (двойной контур) | ≤ **30 мин** |

---

## 3) Архитектура резервирования
### 3.1 PostgreSQL (PITR)
- **Ежедневные base‑backup** + **непрерывный WAL‑архив** в объектное хранилище (`s3://backups/db/…`).  
- Гео‑репликация бакета (region‑B).  
- Включён `pgbackrest`/`wal‑gzip` с проверкой CRC и каталогом манифестов.

### 3.2 Evidence/файлы
- S3‑совместимое хранилище с **версионированием** + **Object Lock (compliance)**, срок WORM ≥ 30 дней.  
- Ежедневная **реплика** бакета в DR‑регион.  
- Проверка целостности — сканер ETag/MD5, отчёты.

### 3.3 Конфиги/секреты
- `config_snapshot` — в БД + выгрузка в зашифрованный архив (`KMS‑AES256`) раз в 6 ч.  
- Секреты (webhook secrets, RPC keys) — в Secret‑Manager (vault), **снимки** и **версионирование** включены.  
- JWKS: публичные ключи — в репозитории с тегами; приватные — в HSM/офлайн, резерв по **M‑of‑N** (см. SOP кошельков).

### 3.4 Метрики/логи/трейсы
- Prometheus: **remote‑write** в долговременное хранилище + снапшоты метаданных Grafana.  
- Loki/ELK: партиции, ретенции (90д горячие, 365д тёплые), ежедневные снимки индексов.

---

## 4) Расписания/ретенции
- **DB base‑backup**: ежедневно 02:00 CEST; хранение: 30 суток; WAL — 7 суток.  
- **Files (S3)**: непрерывное версионирование; экспирация старых версий через 180 дней; DR‑реплика — 30 суток.  
- **Конфиги/секреты**: снимки каждые 6 ч; хранение 90 дней.  
- **Логи/метрики**: как в «Мониторинг (v1)» (15 мес метрики; логи 90/365).  
- **Арбитражные материалы**: ≥ **24 мес** после закрытия спора (см. Правила арбитража v2).

---

## 5) Шифрование и доступ
- Все бэкапы — **encrypt‑at‑rest** (KMS/Vault) + **TLS in transit**.  
- Доступ — по ролям (RO/Restore/Admin), **2FA**, IP allow‑list.  
- Операции удаления/очистки — требуют M‑of‑N подтверждения и журналируются в `audit_log`.

---

## 6) Верификация бэкапов
- **Ежедневная проверка** целостности (манифест + контрольные суммы).  
- **Еженедельный test‑restore** на staging:
  - DB PITR на произвольный timestamp T‑X минут;
  - выборочное восстановление 100 файлов evidence;
  - восстановление config_snapshot и перезапуск тестового сервиса.  
- **Ежеквартальный DR‑drill**: полный сценарий «потеря региона» (см. §8), отчёт с метриками RPO/RTO.

---

## 7) Процедуры восстановления
### 7.1 PostgreSQL — PITR
1. Поднять пустой инстанс в DR (версия совпадает).  
2. Восстановить **последний base‑backup**.  
3. Применить WAL до целевого времени (по `recovery_target_time`) или до последнего.  
4. Запустить миграции (если есть), сверить контрольные суммы и счётчики.  
5. Переключить трафик (readiness probes, DNS TTL ≤ 60с).

### 7.2 Files — точечное/массовое
- Восстановить конкретную версию по `object key + versionId`; массово — по манифесту префикса/даты.

### 7.3 Конфиги/секреты
- Развернуть `config_snapshot` нужной версии;
- восстановить версии секретов в Secret‑Manager;
- JWKS — перевыпустить при необходимости.

### 7.4 Переиндексация/согласование
- Пересчитать агрегаты (`company_limit_snapshot`, экспозицию) и сверить `deposit_ledger`.  
- **Replay вебхуков** за окно инцидента (`/events` + `/webhooks/{id}/replay`).  
- **Рескан блокчейна** для входящих/исходящих tx за окно инцидента.

---

## 8) DR/BCP — аварийное переключение
- **Горячее резервирование**: DR‑регион с инфраструктурой «наготове» (IaC), S3‑реплика, готовые образы.  
- Триггер SEV1 → решение Platform Admin → запуск плана DR:
  1) развернуть DB из последнего снапшота + WAL до `now‑RPO`;  
  2) подключить бакеты файлов;  
  3) восстановить конфиги/секреты;  
  4) поднять боты/API;  
  5) переключить DNS/Ingress.  
- **Возврат** в основной регион — по отдельной процедуре (двунаправленная репликация/фриз на запись).

---

## 9) Мониторинг и оповещения
- Алерты: `backup_success=0`, `wal_archive_lag > RPO`, `s3_replication_lag > threshold`, `object_lock_disabled`, провалы test‑restore.  
- Еженедельный отчёт: статус бэкапов, DR‑drill, недочёты и план исправлений.

---

## 10) Документация и хранение артефактов
- Журналы бэкапов/test‑restore — в отдельном бакете `s3://backups/reports/…` (WORM 30 дней).  
- Отчёты DR‑drill — в Confluence/репозитории, ссылка в @OpsAdminBot.

---

## 11) Роли и RACI
| Процесс | R | A/C/I |
|---|---|---|
| Ежедневные бэкапы | DevOps | A: Platform Admin; I: Treasury |
| Еженедельный test‑restore | DevOps Lead | A: QA; I: Risk |
| DR‑drill ежеквартально | Platform Admin | C: DevOps/Treasury/Risk |
| Обслуживание KMS/Vault | DevOps | A: Platform Admin |
| Утверждение политики/ретенций | Platform Admin | C: Legal/Risk |

---

## 12) Чек‑листы
### Daily
- [ ] DB base‑backup OK; WAL лаг < 5 мин.  
- [ ] S3 replication OK; Object Lock включён.  
- [ ] Свободное место ≥ 30%.  

### Weekly
- [ ] Test‑restore DB PITR успешен.  
- [ ] Выборочное восстановление 100 файлов OK.  
- [ ] Конфиги/секреты восстановлены на stg.

### Quarterly (DR)
- [ ] Сценарий «потеря региона» — RPO/RTO в пределах целей.  
- [ ] Отчёт и корректирующие действия.

---

## 13) Соответствие другим документам
- SOP кошельков (v1), Мониторинг (v1), Runbooks (v1), Админ‑консоль (v1), Правила арбитража (v2).
