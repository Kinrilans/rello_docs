# План реагирования на инциденты (v1) — Security/Ops

Часовой пояс: **Europe/Warsaw**. Область: боты/API, payout‑engine, Trust/EOD, кошельки, вебхуки, БД/инфра.

---

## 0) Цели и принципы
- Минимизировать **время простоя** и **потери средств/данных**.
- Единая шкала **SEV1–SEV3** и предсказуемые действия.
- Коммуникация «одним голосом», прозрачные апдейты партнёрам.
- Всё фиксируется в **аудит‑таймлайне** и заканчивается **постмортемом**.

---

## 1) Классификация инцидентов
| Уровень | Примеры | Цели (MTTA / MTTR) |
|---|---|---|
| **SEV1 (крит.)** | Массовая остановка выплат/EOD; компрометация ключей; потеря БД; недоступны обе сети | **≤15 мин** / **≤4 ч** |
| **SEV2 (выс.)** | Сеть/ERC или TRON деградирует; очередь выплат растёт; вебхуки массово retry | **≤30 мин** / **≤12 ч** |
| **SEV3 (умер.)** | Единичные stuck‑tx; проблемы одного партнёра; мелкие баги | **≤2 ч** / **≤48 ч** |

Триггеры и пороги — см. «Мониторинг и алерты (v1)» §3.

---

## 2) Роли и RACI
- **Incident Commander (IC)** — ведёт инцидент, принимает решения (по умолчанию: Ops on‑call).  
- **Comms Lead** — внешние/внутренние сообщения (PM/Support).  
- **Treasury Lead** — кошельки, выплаты, ликвидность.  
- **DevOps Lead** — RPC/инфра, БД, бэкапы/DR.  
- **Risk/Arbiter** — правила, споры, возможные удержания.  
- **Platform Admin** — эскалация/фриз, M‑of‑N подтверждения.

Контакты/чаты: шаблон канала `#inc-YYYYMMDD-hhmm-topic`.

---

## 3) Жизненный цикл «6 шагов»
1) **Detect** — алёрт от Grafana/Alertmanager/@OpsAdminBot или партнёра.  
2) **Triage** — присвоить SEV, назначить IC, собрать первичную телеметрию (последние 60 мин).  
3) **Communicate** — открыть канал, оповестить внутренний чат; при SEV1/2 — отправить первый статус партнёрам (шаблоны §8).  
4) **Mitigate** — локализовать проблему (safe‑mode, перевести выплаты, отключить сеть/кошелёк, пауза EOD).  
5) **Resolve/Recover** — восстановить сервис (replay вебхуков, speed‑up/cancel, PITR/DR).  
6) **Postmortem** — в 72 ч: причины, действия, улучшения, срок закрытия.

---

## 4) Типовые сценарии и плейбуки
### 4.1 Сеть ERC‑20/fee‑шквал → массовые stuck‑tx (SEV2)
- Действия (≤15 мин): поднять `fee_mode=priority`, включить `speed_up`; перенаправить часть выплат на TRC‑20 (если допустимо).  
- Если p95 `payout_latency` > 30 мин 2 окна подряд → **safe‑mode**: остановить EOD на ERC‑20, оставить pass‑through/малые батчи.  
- Коммс: уведомить партнёров о задержках, ETА улучшения (шаблон §8).

### 4.2 TRON: нехватка Energy/Bandwidth (SEV2)
- Действия: докупить/перекинуть TRX, арендовать энергию, переключить RPC; временно уменьшить cap per‑tx.  
- Если задержки > порога — **partial/T+1** по EOD.

### 4.3 Компрометация hot‑кошелька/подписанта (SEV1)
- Немедленно: **safe‑mode** → stop payouts по сети; **emergency drain** на cold; отзыв прав подписанта; ротация ключей/JWKS.  
- Аудит: выгрузить подозрительные tx, логи подписи, IP/UA.  
- Пост‑действия: новый hot‑кошелёк по SOP; отчёт партнёрам.

### 4.4 БД/данные: потеря узла/коррупция (SEV1)
- PITR: восстановиться до `now-RPO` (см. Backup/Restore §7), прогнать миграции, сверить суммы.  
- **Replay** вебхуков и **рескан блокчейна** за окно инцидента; сверить `deposit_ledger` и `company_limit_snapshot`.

### 4.5 Вебхуки массово в dead‑letter (SEV2)
- Увеличить таймауты, связаться с получателями; выполнить **bulk replay** после стабилизации.  
- Коммс: англ. уведомление о деградации, указать окна/ожидания.

### 4.6 Trust/EOD: неудачные расчёты (SEV2)
- Принудительно `session.close()`; сформировать частичные выплаты; остаток T+1; уведомления.  
- Рассчитать корректировки ledger при споре; арбитраж при расхождениях.

---

## 5) Safe‑mode и управляемая деградация
Переключатели (админ‑консоль):
- **EOD off** (сети/все); **freeze manual payouts**; **freeze deposit withdraw**; «pass‑through only».  
- Баннеры статуса в ботах; вебхукам — не рассылать шумные события (только итоговые).  
- Выход — по чек‑листу (§9) и M‑of‑N.

---

## 6) Артефакты и сбор доказательств
- Таймлайн: `ts, actor, action, evidence_link, trace_id`.
- Логи: payout‑engine, RPC, webhooks; дашборды (скриншоты/PNG).  
- TX: хэши, адреса, скрины мемпула/газ‑рынка.  
- Для споров — выгрузки `trust_session/ledger`, решения арбитров.

---

## 7) RACI и эскалации
| Действие | R | A/C/I |
|---|---|---|
| Объявить SEV/назначить IC | Ops on‑call | A: Platform Admin |
| Safe‑mode включить/выключить | IC | A: Platform Admin; C: Treasury |
| Эмердженси drain | Treasury | A: Platform Admin; C: DevOps |
| DR/PITR | DevOps | A: Platform Admin |
| Коммс внешние | Comms Lead | A: Platform Admin; I: Partners |
| Постмортем | IC | C: DevOps/Treasury/Risk/PM |

Контакты эскалации у партнёров — хранятся в карточке компании.

---

## 8) Шаблоны коммуникаций
**RU — первый статус (SEV2/SEV1)**
> Обнаружена деградация в сети {NETWORK}. Выплаты могут задерживаться (p95 ~ {X} мин). Мы включили {SAFE_MODE/MEASURES}. Следующий апдейт в {HH:MM} (CEST).

**EN — webhooks degraded**
> We see degraded webhook delivery between {FROM}–{TO}. Retries are in progress; once stabilized we’ll replay all events from that window.

**RU — завершение**
> Инцидент закрыт. Причина: {ROOT_CAUSE}. Длительность: {DURATION}. Сделки/выплаты подтверждены, остатки по EOD — T+1. Постмортем опубликуем до {DATE}.

---

## 9) Чек‑листы
**Старт инцидента**
- [ ] Алёрт подтверждён; SEV присвоен; IC назначен.  
- [ ] Канал создан; роли назначены; таймлайн начат.  
- [ ] Первый статус отправлен (при SEV1/2).

**Mitigation**
- [ ] Safe‑mode/переключатели применены.  
- [ ] Ликвидность hot проверена; ребаланс при необходимости.  
- [ ] Переход на резервный RPC/кошелёк выполнен.

**Восстановление**
- [ ] PITR/DR (если нужно) завершён; консистентность сверена.  
- [ ] Webhooks replay; рескан блокчейна.  
- [ ] Очереди выплат очищены; p95 в норме.

**Выход из инцидента**
- [ ] Баннеры сняты; safe‑mode выключен по M‑of‑N.  
- [ ] Итоговое сообщение отправлено.  
- [ ] Завести таски на улучшения/фиксы.

**Постмортем (72 ч)**
- [ ] Факты/таймлайн; корневая причина; что сработало/нет; план.

---

## 10) Связанные документы
- Runbooks (v1), Мониторинг и алерты (v1), SOP кошельков (v1), Backup/Restore (v1), Админ‑консоль (v1), Правила арбитража (v2).

---

## 11) To‑Do для следующей версии
- Авто‑создание инцидента из @OpsAdminBot (кнопка **Open Incident** + шаблон ролей).  
- Каталог типовых RCA и контрольные списки улучшений.  
- Локализация шаблонов (RU/EN) и предустановленные окна апдейтов.  
- Еженедельные SEV‑дрили (30 мин) по одному сценарию.

