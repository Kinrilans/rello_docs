# SOP кошельков (v1) — hot/cold, подписи, лимиты, allow‑list

Часовой пояс: **Europe/Warsaw**. Активы: **USDT/USDC**. Сети: **ERC‑20 / TRC‑20**. Сферы: приём входящих (pass‑through), исходящие выплаты (auto/manual/EOD), депозиты, ребаланс hot/cold. Это операционный стандарт для казначейства и DevOps.

---

## 0) Роли и разделение обязанностей
- **Treasury Admin** — владелец кошельков/лимитов, запускает ребалансы, утверждает изменения.  
- **Signer** — подписант транзакций (через HSM/мультиподпись/аппаратный ключ).  
- **DevOps** — RPC/инфра, мониторинг, алерты, управление ключами/JWKS.  
- **Risk Admin** — cap’ы, стоп‑листы, trust/EOD‑правила.  
- **Platform Admin** — M‑of‑N финальное утверждение критичных изменений.  

**Принцип 4‑х глаз:** для критичных действий (включение нового hot, drain, смена cap’ов) требуется раздельное подтверждение 2+ ролями.

---

## 1) Типы кошельков и назначение
- **Hot‑кошельки (отправка):** выплатные адреса по сетям (ERC‑20/TRC‑20). Минимум 2 на сеть (primary/backup), ротация.  
- **Deposit‑адреса (приём):** адреса Платформы для `pay_in` (pass‑through). По сети токену — статический адрес/пул адресов с метками.  
- **Cold‑хранилище:** офлайн/аппаратные средства хранения резервов и страховочного буфера газа (ETH/TRX).  

**Сегментация по назначению:** раздельные hot‑кошельки для `pass_through`, `EOD`, `manual/arbiter` (уменьшает blast‑radius).

---

## 2) Сети: особенности и эксплуатация
### ERC‑20 (ETH)
- **Газ (EIP‑1559):** держать буфер ETH ≥ `gas_safety_buffer` (см. админ‑консоль).  
- **Cap per‑tx:** по умолчанию 250k USDT экв.; крупное — батчевать с паузой.  
- **Stuck‑tx:** `speed_up/cancel` политикой engine (см. Runbooks §2).

### TRC‑20 (TRON)
- **Energy/Bandwidth:** держать TRX‑буфер; при больших потоках — стейк/арендовать энергию.  
- **Cap per‑tx:** по умолчанию 200k USDT экв.; также батчевать.  
- **RPC‑фейлы:** переключение на резервный RPC.

---

## 3) Ключи и подпись: политика
- **Генерация ключей:** офлайн‑машина/аппаратный кошелёк; энтропия не ниже 256 бит; записи в журнале генерации.  
- **Хранение:**
  - Hot: **HSM/подписывающий сервис** с доступом по ролям; ключи вне приложения.  
  - Cold: аппаратные кошельки/мультисейф, сейфовая ячейка; резервные фрагменты — **M‑of‑N** (например, 2‑из‑3/3‑из‑5) с гео‑разделением.  
- **Мультиподпись:**
  - ERC‑20: контрактный мультисейф (напр., 2‑из‑3 или 3‑из‑5).  
  - TRON: «Multiple sign permissions» (account permissions) с порогом.  
- **Ротация:** плановая раз в 6–12 мес либо при инциденте; `dual‑run` окно; тест‑выплата 1 USDT после переключения.  
- **Аудит доступа:** минимальные привилегии, все вызовы подписанта логируются с `trace_id`.

---

## 4) Allow‑list и верификация адресов
- Все адреса получателей — **только из allow‑list** компании.  
- Добавление нового адреса: верификация через @ClubGateBot (подпись/микро‑tx/оф. письмо), второй фактор Approver; отображение «верифицирован».  
- Попытка payout на неразрешённый адрес → **блок** (422) + алерт Risk.  
- Адреса hot/cold зашиты в конфигурации и защищены M‑of‑N изменениями.

---

## 5) Лимиты и предохранители
- **Per‑tx cap** по сети/токену (см. «Таблица tier’ов (v2)», «Engine (v1)»).  
- **Дневной cap авто‑выплат** (pass‑through) и cap открытой экспозиции — по tier.  
- **Пороговые суммы для Approver** — по tier.  
- **Safe‑mode:** переключатели «EOD off», «freeze manual payouts», «freeze withdraw» — активируются при инцидентах.

---

## 6) Ребаланс hot/cold
**Триггеры:** падение ниже `min_hot_balance`, подготовка к EOD, плановый трансфер.

**Процедура**
1. Создать заявку ребаланса (ticket), указать сеть/суммы/адреса.  
2. Подписи M‑of‑N (cold → hot), назначить временное окно.  
3. Отправить **тест 1 USDT** → подтвердить поступление.  
4. Отправить основной перевод → дождаться `min_confirmations`.  
5. Обновить инвентарь кошельков, пометить ticket «done».

---

## 7) Подключение нового hot‑кошелька
1. Сгенерировать ключ (офлайн) / создать мультисейф.  
2. Задеплоить/подключить к подписанту (HSM), выдать роль **Signer**.  
3. Внести в реестр кошельков: сеть, адрес, теги, пороги, cap’ы.  
4. Прогнать **тест‑выплату 1 USDT** на внутренний адрес.  
5. Включить в engine; поставить канарейку на сутки; включить мониторинг.

---

## 8) Ротация/вывод из эксплуатации hot‑кошелька
1. Переключить engine на `backup` (drain).  
2. Перевести остатки на cold/hot‑new; закрыть pending tx.  
3. Обновить allow‑list/конфиги; отозвать роли у ключей.  
4. Архивировать логи; пометить адрес `retired`.

---

## 9) Инциденты и компрометация
**Сигналы:** несанкционированные транзакции, утечка ключа, подозрительные вызовы подписанта.

**Действия (≤15 мин)**
1. **Safe‑mode:** остановить выплаты по сети/кошельку.  
2. Переключить RPC на резервный (если связано).  
3. Выполнить **emergency drain** на cold (мультиподпись).  
4. Отозвать ключ/подписанта, ротация JWKS (если затронут WebApp).  
5. Коммуникации партнёрам/внутри (см. Runbooks §9 шаблоны).  
6. Создать инцидентный канал, начать сбор артефактов (tx, логи, трейс).  
7. После стабилизации — RCA и корректирующие меры.

---

## 10) Учёт, аудит и мониторинг
- Инвентарь кошельков: таблица по сетям, роли, пороги, даты тестов/ротаций.  
- Логи подписей/выплат — в централизованном хранилище (Loki/ELK) ≥ 90 дней горячих, 365 тёплых.  
- Метрики: баланс token/газ, latency выплат, stuck‑tx, ошибки RPC; алерты — см. «Мониторинг (v1)».

---

## 11) Чек‑листы
### Ежедневный (утро)
- [ ] Баланс hot (USDT/USDC) и газ (ETH/TRX) ≥ порогов.  
- [ ] Очередь выплат и stuck‑tx = 0; вебхуки без dead‑letter.  
- [ ] Канареечные выплаты зелёные.

### Перед EOD
- [ ] Прогноз net по парам; достаточность ликвидности hot.  
- [ ] При дефиците — решить: ребаланс или **partial/T+1**.  
- [ ] Проверить cap per‑tx и паузы батчинга.

### Подключение нового hot
- [ ] Ключ создан/проверен; HSM/мультисейф подключён.  
- [ ] Адрес в реестре; пороги/лимиты выставлены.  
- [ ] Тест 1 USDT пройден; мониторинг включён.  

### Компрометация
- [ ] Safe‑mode включён.  
- [ ] Drain выполнен.  
- [ ] Ключи отозваны; партнёры уведомлены.  
- [ ] RCA/постмортем запланирован.

---

## 12) Хранение секретов и доступы
- Секреты (RPC, HSM, API) — в секрет‑менеджере; доступ по ролям, все чтения логируются.  
- 2FA и привязка устройств для админ‑панелей/подписанта.  
- IP allow‑list для доступа к админ‑консоли и HSM.

---

## 13) Политика тестов и канареек
- Еженедельная канарейка 1 USDT по каждой сети и каждому hot‑кошельку.  
- Ежемесячный тест **emergency drain** (staging) и **backup RPC failover**.  
- Ежеквартальная ротация прав/ревью ролей.

---

## 14) Соответствие другим документам
- «Engine авто‑выплат (v1)», «Runbooks (v1)», «Мониторинг (v1)», «Админ‑консоль (v1)», «Таблица tier’ов (v2)».

---

## 15) Что осталось/To‑Do
- **Backup/Restore (v1)** — расписать схемы бэкапов для БД, файлов арбитража, ключевых конфигов; RPO/RTO; тест восстановления.  
- **Incident Response Plan (v1)** — формализовать роли/эскалации, чек‑листы коммуникаций, интеграцию с @OpsAdminBot.  
- **План запуска (pilot → go‑live)** — таймлайн, freeze‑план, коммуникации, канареечные кошельки.  
- **Тексты ботов v1** — единый словарь сообщений (help/ошибки/уведомления) RU/EN.  
- (Опционально) **UX‑вайрфреймы** ключевых экранов казначейства/пар/арбитража.

